<div class="page container py-3">
  <h1 class="h4 m-0 mb-3">Parámetros del Sistema</h1>

  <div class="alerts" *ngIf="alertMessage">
    <div class="alert" [class.success]="alertType==='success'" [class.error]="alertType==='error'" [class.warning]="alertType==='warning'">
      {{ alertMessage }}
    </div>
  </div>

  <!-- Navegación de pestañas -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab==='pe'" (click)="setTab('pe')">
        <i class="fas fa-coins me-1"></i> Parámetros Económicos
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="activeTab==='ic'" (click)="setTab('ic')">
        <i class="fas fa-file-invoice-dollar me-1"></i> Items de Cobro
      </button>
    </li>
  </ul>

  <!-- Parámetros Económicos -->
  <section class="card" *ngIf="activeTab === 'pe'">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h2 class="h5 m-0">Parámetros Económicos</h2>
      <div class="d-flex gap-2 align-items-center">
        <input type="text" class="form-control" placeholder="Buscar por nombre o descripción..." [(ngModel)]="searchPE" />
        <button class="btn btn-primary" (click)="openNewParametro()"><i class="fas fa-plus me-1"></i> Nuevo</button>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Nombre</th>
              <th>Valor</th>
              <th>Descripción</th>
              <th>Estado</th>
              <th>Creado</th>
              <th>Actualizado</th>
              <th class="text-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let p of filteredParametros">
              <td>{{ p.id_parametro_economico }}</td>
              <td>
                <div class="fw-semibold">{{ p.nombre }}</div>
              </td>
              <td>{{ p.valor }}</td>
              <td>{{ p.descripcion }}</td>
              <td>
                <span class="badge" [ngClass]="p.estado ? 'bg-success' : 'bg-danger'">{{ p.estado ? 'Activo' : 'Inactivo' }}</span>
              </td>
              <td>{{ p.created_at ? (p.created_at | date:'dd/MM/yyyy') : '-' }}</td>
              <td>{{ p.updated_at ? (p.updated_at | date:'dd/MM/yyyy') : '-' }}</td>
              <td class="text-nowrap">
                <button class="btn btn-sm btn-outline-secondary me-1" title="Cambiar estado" (click)="toggleParametro(p)">
                  <i class="fas" [ngClass]="p.estado ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary me-1" title="Editar" (click)="openEditParametro(p)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Eliminar" (click)="confirmDelete(p, 'pe')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredParametros.length === 0">
              <td colspan="8" class="text-center py-4">Sin resultados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Items de Cobro -->
  <section class="card" *ngIf="activeTab === 'ic'">
    <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
      <h2 class="h5 m-0">Items de Cobro</h2>
      <div class="d-flex gap-2 align-items-center">
        <input type="text" class="form-control" placeholder="Buscar por nombre, código o descripción..." [(ngModel)]="searchIC" />
        <button class="btn btn-primary" (click)="openNewItem()"><i class="fas fa-plus me-1"></i> Nuevo</button>
      </div>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead class="table-light">
            <tr>
              <th>Nro</th>
              <th>Cód. Impuesto</th>
              <th>Cód. Interno</th>
              <th>Nombre Servicio</th>
              <th>Créditos</th>
              <th>Costo</th>
              <th>Actividad Económica</th>
              <th>Descripción</th>
              <th>Facturado</th>
              <th>Estado</th>
              <th class="text-nowrap">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let i of filteredItems; let idx = index">
              <td>{{ idx + 1 }}</td>
              <td>{{ i.codigo_producto_impuesto || '-' }}</td>
              <td>{{ i.codigo_producto_interno }}</td>
              <td>
                <div class="fw-semibold">{{ i.nombre_servicio }}</div>
              </td>
              <td>{{ i.nro_creditos }}</td>
              <td>{{ i.costo != null ? (i.costo | currency) : '-' }}</td>
              <td>{{ i.actividad_economica }}</td>
              <td>{{ i.descripcion || '-' }}</td>
              <td>
                <span class="badge" [ngClass]="i.facturado ? 'bg-success' : 'bg-danger'">{{ i.facturado ? 'Sí' : 'No' }}</span>
              </td>
              <td>
                <span class="badge" [ngClass]="i.estado ? 'bg-success' : 'bg-danger'">{{ i.estado ? 'Activo' : 'Inactivo' }}</span>
              </td>
              <td class="text-nowrap">
                <button class="btn btn-sm btn-outline-secondary me-1" title="Cambiar estado" (click)="toggleItem(i)">
                  <i class="fas" [ngClass]="i.estado ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
                </button>
                <button class="btn btn-sm btn-outline-primary me-1" title="Editar" (click)="openEditItem(i)">
                  <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-sm btn-outline-danger" title="Eliminar" (click)="confirmDelete(i, 'ic')">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            <tr *ngIf="filteredItems.length === 0">
              <td colspan="11" class="text-center py-4">Sin resultados</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Modal: Parámetro Económico -->
  <div class="overlay-backdrop" *ngIf="showParamModal">
    <div class="overlay-modal">
      <h3>{{ editingParam ? 'Editar Parámetro' : 'Nuevo Parámetro' }}</h3>
      <form [formGroup]="parametroForm" (ngSubmit)="saveParametro()">
        <div class="grid">
          <label>
            Nombre
            <input type="text" formControlName="nombre" />
          </label>
          <label>
            Valor
            <input type="text" formControlName="valor" />
          </label>
          <label class="col-span-2">
            Descripción
            <textarea rows="2" formControlName="descripcion"></textarea>
          </label>
          <label class="row-center">
            <input type="checkbox" formControlName="estado" /> Activo
          </label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" [disabled]="parametroForm.invalid">Guardar</button>
          <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Item de Cobro -->
  <div class="overlay-backdrop" *ngIf="showItemModal">
    <div class="overlay-modal">
      <h3>{{ editingItem ? 'Editar Item de Cobro' : 'Nuevo Item de Cobro' }}</h3>
      <form [formGroup]="itemForm" (ngSubmit)="saveItem()">
        <div class="grid">
          <label>
            Cód. Impuesto
            <input type="number" formControlName="codigo_producto_impuesto" />
          </label>
          <label>
            Cód. Interno
            <input type="text" formControlName="codigo_producto_interno" />
            <small class="error" *ngIf="itemForm.get('codigo_producto_interno')?.touched && itemForm.get('codigo_producto_interno')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('codigo_producto_interno')?.touched && itemForm.get('codigo_producto_interno')?.hasError('maxlength')">Máximo 15 caracteres.</small>
            <small class="error" *ngIf="itemForm.get('codigo_producto_interno')?.touched && itemForm.get('codigo_producto_interno')?.hasError('backend')">{{ itemForm.get('codigo_producto_interno')?.errors?.['message'] }}</small>
          </label>
          <label>
            Unidad Medida
            <input type="number" formControlName="unidad_medida" />
            <small class="error" *ngIf="itemForm.get('unidad_medida')?.touched && itemForm.get('unidad_medida')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('unidad_medida')?.touched && itemForm.get('unidad_medida')?.hasError('backend')">{{ itemForm.get('unidad_medida')?.errors?.['message'] }}</small>
          </label>
          <label>
            Nombre Servicio
            <input type="text" formControlName="nombre_servicio" />
            <small class="error" *ngIf="itemForm.get('nombre_servicio')?.touched && itemForm.get('nombre_servicio')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('nombre_servicio')?.touched && itemForm.get('nombre_servicio')?.hasError('maxlength')">Máximo 100 caracteres.</small>
            <small class="error" *ngIf="itemForm.get('nombre_servicio')?.touched && itemForm.get('nombre_servicio')?.hasError('backend')">{{ itemForm.get('nombre_servicio')?.errors?.['message'] }}</small>
          </label>
          <label>
            Créditos
            <input type="number" formControlName="nro_creditos" />
            <small class="error" *ngIf="itemForm.get('nro_creditos')?.touched && itemForm.get('nro_creditos')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('nro_creditos')?.touched && itemForm.get('nro_creditos')?.hasError('min')">Debe ser mayor o igual a 0.</small>
            <small class="error" *ngIf="itemForm.get('nro_creditos')?.touched && itemForm.get('nro_creditos')?.hasError('backend')">{{ itemForm.get('nro_creditos')?.errors?.['message'] }}</small>
          </label>
          <label>
            Costo
            <input type="number" step="0.01" formControlName="costo" />
            <small class="error" *ngIf="itemForm.get('costo')?.touched && itemForm.get('costo')?.hasError('min')">Debe ser mayor o igual a 0.</small>
            <small class="error" *ngIf="itemForm.get('costo')?.touched && itemForm.get('costo')?.hasError('backend')">{{ itemForm.get('costo')?.errors?.['message'] }}</small>
          </label>
          <label>
            Actividad Económica
            <input type="text" formControlName="actividad_economica" />
            <small class="error" *ngIf="itemForm.get('actividad_economica')?.touched && itemForm.get('actividad_economica')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('actividad_economica')?.touched && itemForm.get('actividad_economica')?.hasError('backend')">{{ itemForm.get('actividad_economica')?.errors?.['message'] }}</small>
          </label>
          <label class="col-span-2">
            Descripción (máx. 50)
            <textarea rows="2" maxlength="50" formControlName="descripcion"></textarea>
          </label>
          <label>
            Tipo Item
            <input type="text" formControlName="tipo_item" />
            <small class="error" *ngIf="itemForm.get('tipo_item')?.touched && itemForm.get('tipo_item')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('tipo_item')?.touched && itemForm.get('tipo_item')?.hasError('maxlength')">Máximo 40 caracteres.</small>
            <small class="error" *ngIf="itemForm.get('tipo_item')?.touched && itemForm.get('tipo_item')?.hasError('backend')">{{ itemForm.get('tipo_item')?.errors?.['message'] }}</small>
          </label>
          <label>
            Parámetro Económico
            <select formControlName="id_parametro_economico">
              <option [ngValue]="null">Seleccione...</option>
              <option *ngFor="let p of parametros" [ngValue]="p.id_parametro_economico">{{ p.nombre }}</option>
            </select>
            <small class="error" *ngIf="itemForm.get('id_parametro_economico')?.touched && itemForm.get('id_parametro_economico')?.hasError('required')">Requerido.</small>
            <small class="error" *ngIf="itemForm.get('id_parametro_economico')?.touched && itemForm.get('id_parametro_economico')?.hasError('backend')">{{ itemForm.get('id_parametro_economico')?.errors?.['message'] }}</small>
          </label>
          <label class="row-center">
            <input type="checkbox" formControlName="facturado" /> Facturado
          </label>
          <label class="row-center">
            <input type="checkbox" formControlName="estado" /> Activo
          </label>
        </div>
        <div class="modal-actions">
          <button type="submit" class="btn btn-primary" [disabled]="itemForm.invalid">Guardar</button>
          <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Confirmación Eliminar -->
  <div class="overlay-backdrop" *ngIf="showDeleteModal">
    <div class="overlay-modal">
      <h3>Confirmar eliminación</h3>
      <p>¿Seguro que deseas eliminar este registro?</p>
      <div class="modal-actions">
        <button class="btn btn-danger" (click)="doDelete()">Eliminar</button>
        <button class="btn btn-secondary" (click)="cancelDelete()">Cancelar</button>
      </div>
    </div>
  </div>
</div>
