<div class="container py-3">
	<h2 class="mb-3">Gestión de Cobros</h2>

	<!-- Alertas -->
	<div *ngIf="alertMessage" class="alert" [ngClass]="{
		'alert-success': alertType === 'success',
		'alert-danger': alertType === 'error',
		'alert-warning': alertType === 'warning'
	}">{{ alertMessage }}</div>

	<!-- Resumen -->
	<div class="card mb-4 shadow-sm">
		<div class="card-header d-flex justify-content-between align-items-center">
			<strong>Resumen de Pagos del Estudiante</strong>
			<button type="button" class="btn btn-sm btn-outline-primary" [disabled]="!resumen" (click)="openKardexModal()">
				<i class="bi bi-journal-text me-1"></i>Kardex económico
			</button>
		</div>
		<div class="card-body">
			<form [formGroup]="searchForm" (ngSubmit)="loadResumen()" class="row g-3">
				<div class="col-md-4">
					<label class="form-label">Código CETA</label>
					<input class="form-control" formControlName="cod_ceta" placeholder="Ej: 20201234" />
				</div>
				<div class="col-md-3">
					<label class="form-label">Gestión (opcional)</label>
					<input class="form-control" formControlName="gestion" placeholder="Ej: 2025-1" />
				</div>
				<div class="col-md-2 d-flex align-items-end">
					<button class="btn btn-primary w-100" [disabled]="loading" type="submit">
						<i class="bi bi-search me-1"></i> Consultar
					</button>
				</div>
			</form>

			<hr />

			<div *ngIf="resumen as r">
				<div class="row mb-3">
					<div class="col-md-6">
						<h6>Estudiante</h6>
						<div class="small text-muted">{{ r?.estudiante?.cod_ceta }} - {{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres }}</div>
						<div class="small">Pensum: {{ r?.inscripcion?.cod_pensum }} | Tipo: {{ r?.inscripcion?.tipo_inscripcion }}</div>
					</div>
					<div class="col-md-6">
						<h6>Totales</h6>
						<ul class="list-unstyled mb-0">
							<li>Monto Semestral: <strong>{{ r?.totales?.monto_semestral | number: '1.2-2' }}</strong></li>
							<li>Total Pagado: <strong class="text-success">{{ r?.totales?.total_pagado | number: '1.2-2' }}</strong></li>
							<li>Saldo Mensualidad: <strong class="text-danger">{{ r?.totales?.saldo_mensualidad | number: '1.2-2' }}</strong></li>
						</ul>
					</div>
				</div>

				<div class="mt-3">
					<details>
						<summary>Ver JSON del resumen</summary>
						<pre class="bg-light p-2 small border rounded mt-2">{{ r | json }}</pre>
					</details>
				</div>
			</div>

			<div *ngIf="!resumen" class="text-muted small">Ingrese un código y consulte para ver el resumen.</div>
		</div>
	</div>

	<!-- Batch -->
	<div class="card shadow-sm">
		<div class="card-header d-flex justify-content-between align-items-center">
			<strong>Registro por Lote de Cobros</strong>
			<button class="btn btn-sm btn-outline-secondary" (click)="addPago()"><i class="bi bi-plus"></i> Agregar Pago</button>
		</div>
		<div class="card-body">
			<form [formGroup]="batchForm" (ngSubmit)="submitBatch()">
				<div class="row g-3" formGroupName="cabecera">
					<div class="col-md-3">
						<label class="form-label">Cod. CETA</label>
						<input class="form-control" formControlName="cod_ceta" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Pensum</label>
						<input class="form-control" formControlName="cod_pensum" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Tipo Inscripción</label>
						<input class="form-control" formControlName="tipo_inscripcion" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Gestión</label>
						<input class="form-control" formControlName="gestion" placeholder="opcional" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Forma cobro</label>
						<input class="form-control" formControlName="id_forma_cobro" placeholder="EF/TR/TC/QR" />
					</div>
					<div class="col-md-3">
						<label class="form-label">Cuenta bancaria</label>
						<input class="form-control" formControlName="id_cuentas_bancarias" placeholder="ID numérico" />
					</div>
					<div class="col-md-3">
						<label class="form-label">ID Usuario</label>
						<input class="form-control" formControlName="id_usuario" placeholder="ID numérico" />
					</div>
				</div>

				<hr />

				<div formArrayName="pagos">
					<div class="table-responsive">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>#</th>
									<th>Nro Cobro</th>
									<th>ID Cuota</th>
									<th>ID Item</th>
									<th>Monto</th>
									<th>Fecha cobro</th>
									<th>Observaciones</th>
									<th></th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let pg of pagos.controls; let i = index" [formGroupName]="i">
									<td>{{ i + 1 }}</td>
									<td><input class="form-control form-control-sm" formControlName="nro_cobro" /></td>
									<td><input class="form-control form-control-sm" formControlName="id_cuota" /></td>
									<td><input class="form-control form-control-sm" formControlName="id_item" /></td>
									<td><input type="number" step="0.01" class="form-control form-control-sm" formControlName="monto" /></td>
									<td><input type="date" class="form-control form-control-sm" formControlName="fecha_cobro" /></td>
									<td><input class="form-control form-control-sm" formControlName="observaciones" /></td>
									<td class="text-center">
										<button type="button" class="btn btn-sm btn-outline-danger" (click)="removePago(i)"><i class="bi bi-trash"></i></button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>

				<div class="d-flex justify-content-end">
					<button class="btn btn-success" [disabled]="loading" type="submit">
						<i class="bi bi-save me-1"></i> Guardar Lote
					</button>
				</div>
			</form>
		</div>
	</div>

	<!-- Modal: Kardex Económico -->
	<div class="modal fade" id="kardexModal" tabindex="-1" aria-labelledby="kardexModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="kardexModalLabel">Kardex económico</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" *ngIf="resumen as r">
					<div class="row g-3 mb-3">
						<div class="col-md-6">
							<div class="small text-muted">{{ r?.estudiante?.cod_ceta }} - {{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres }}</div>
							<div class="small">Pensum: {{ r?.inscripcion?.cod_pensum }} | Tipo: {{ r?.inscripcion?.tipo_inscripcion }}</div>
						</div>
						<div class="col-md-6">
							<ul class="list-unstyled mb-0">
								<li>Monto Semestral: <strong>{{ r?.totales?.monto_semestral | number:'1.2-2' }}</strong></li>
								<li>Total Pagado: <strong class="text-success">{{ r?.totales?.total_pagado | number:'1.2-2' }}</strong></li>
								<li>Saldo Mensualidad: <strong class="text-danger">{{ r?.totales?.saldo_mensualidad | number:'1.2-2' }}</strong></li>
							</ul>
						</div>
					</div>

					<h6 class="mb-2">Mensualidades</h6>
					<div class="table-responsive mb-4">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>Fecha</th>
									<th>Nro Cobro</th>
									<th>Cuota</th>
									<th>Monto</th>
									<th>Forma</th>
									<th>Obs.</th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let m of (r?.cobros?.mensualidad?.items || [])">
									<td>{{ m?.fecha_cobro | date:'yyyy-MM-dd' }}</td>
									<td>{{ m?.nro_cobro }}</td>
									<td>{{ m?.id_cuota ? ('Cuota ' + m?.id_cuota) : '-' }}</td>
									<td>{{ m?.monto | number:'1.2-2' }}</td>
									<td>{{ m?.id_forma_cobro }}</td>
									<td>{{ m?.observaciones }}</td>
								</tr>
							</tbody>
							<tfoot>
								<tr>
									<th colspan="3" class="text-end">Total</th>
									<th>{{ r?.cobros?.mensualidad?.total | number:'1.2-2' }}</th>
									<th colspan="2"></th>
								</tr>
							</tfoot>
						</table>
					</div>

					<h6 class="mb-2">Items</h6>
					<div class="table-responsive">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>Fecha</th>
									<th>Nro Cobro</th>
									<th>Item</th>
									<th>Monto</th>
									<th>Forma</th>
									<th>Obs.</th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let it of (r?.cobros?.items?.items || [])">
									<td>{{ it?.fecha_cobro | date:'yyyy-MM-dd' }}</td>
									<td>{{ it?.nro_cobro }}</td>
									<td>{{ it?.id_item || '-' }}</td>
									<td>{{ it?.monto | number:'1.2-2' }}</td>
									<td>{{ it?.id_forma_cobro }}</td>
									<td>{{ it?.observaciones }}</td>
								</tr>
							</tbody>
							<tfoot>
								<tr>
									<th colspan="3" class="text-end">Total</th>
									<th>{{ r?.cobros?.items?.total | number:'1.2-2' }}</th>
									<th colspan="2"></th>
								</tr>
							</tfoot>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>
</div>
