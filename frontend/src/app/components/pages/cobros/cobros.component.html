<div class="container py-3">
	<h2 class="mb-3">Cobros</h2>

	<!-- Alertas -->
	<div *ngIf="alertMessage" class="alert" [ngClass]="{
		'alert-success': alertType === 'success',
		'alert-danger': alertType === 'error',
		'alert-warning': alertType === 'warning'
	}">{{ alertMessage }}</div>

	<!-- Resumen -->
	<div class="row g-3">
		<div class="col-12 col-lg-8">
			<!-- Batch -->
			<div class="card mb-4 shadow-sm">
				<div class="card-header d-flex justify-content-between align-items-center">
					<strong>Datos del estudiante</strong>
					<button class="btn btn-sm btn-outline-secondary" (click)="addPago()"><i class="bi bi-plus"></i> Agregar Pago</button>
				</div>
				
				<div class="card-body">
					<form [formGroup]="batchForm" (ngSubmit)="submitBatch()">
						<div class="row g-3 cobros-cabecera" formGroupName="cabecera">
							<!-- Mantener en el modelo pero oculto en UI -->
							<input type="hidden" formControlName="tipo_inscripcion" />

							<!-- Columna izquierda -->
							<div class="col-md-6">
								<div class="mb-2">
									<label class="form-label">Código CETA</label>
									<div class="input-group">
										<input class="form-control" formControlName="cod_ceta" />
										<button type="button" class="btn btn-outline-secondary" (click)="buscarPorCodCetaCabecera()">
											<i class="bi bi-search"></i>
										</button>
									</div>
								</div>

								<div [formGroup]="identidadForm" class="row g-3">
									<div class="col-12">
										<label class="form-label">Estudiante</label>
										<input class="form-control" formControlName="nombre_completo" [readonly]="true" />
									</div>
									<div class="col-12">
										<label class="form-label">Razón Social</label>
										<input class="form-control" formControlName="razon_social" [readonly]="true" (click)="openRazonSocialModal()" style="cursor: pointer;" />
									</div>
									<div class="col-12">
										<label class="form-label">Nro Tipo Documento</label>
										<input class="form-control" formControlName="ci" [readonly]="true" (click)="openRazonSocialModal()" style="cursor: pointer;" />
									</div>
									<div class="col-12">
										<label class="form-label">Documento de Identidad</label>
										<select class="form-select" formControlName="tipo_identidad" [disabled]="true">
											<option [ngValue]="1">CI - CEDULA DE IDENTIDAD</option>
											<option [ngValue]="2">CEX - CEDULA DE IDENTIDAD DE EXTRANJERO</option>
											<option [ngValue]="3">PAS - PASAPORTE</option>
											<option [ngValue]="4">OD - OTRO DOCUMENTO DE IDENTIDAD</option>
											<option [ngValue]="5">NIT - NUMERO DE IDENTIFICACION TRIBUTARIA</option>
										</select>
									</div>
								</div>
							</div>

							<!-- Columna derecha -->
							<div class="col-md-6">
								<div class="row g-3">
									<div class="col-12">
										<label class="form-label">Pensum</label>
										<input class="form-control" formControlName="cod_pensum" [readonly]="true" />
									</div>
									<div class="col-12">
										<label class="form-label">Gestión</label>
										<input class="form-control" formControlName="gestion" [readonly]="true" />
									</div>
									<div class="col-12">
										<label class="form-label">Grupo</label>
										<div class="form-control-plaintext border rounded px-2 py-2">
											<ng-container *ngIf="(resumen?.inscripciones?.length || 0) > 0; else noInscripciones">
												<div class="d-flex flex-column gap-2">
													<div class="d-flex align-items-center gap-2" *ngFor="let ins of resumen?.inscripciones">
														<span class="badge rounded-pill bg-primary">{{ ins?.cod_curso || '-' }}</span>
														<span class="badge rounded-pill" [ngClass]="{'bg-warning text-dark': true}">{{ (ins?.tipo_inscripcion || '-').toUpperCase() }}</span>
													</div>
												</div>
											</ng-container>
											<ng-template #noInscripciones>
												<span class="text-muted">{{ resumen?.inscripcion?.cod_curso ? (resumen?.inscripcion?.cod_curso + ' - ' + (resumen?.inscripcion?.tipo_inscripcion || '-')) : '-' }}</span>
											</ng-template>
										</div>
									</div>
									<div class="col-12" [formGroup]="identidadForm">
										<label class="form-label">Email</label>
										<input type="email" class="form-control" formControlName="email" placeholder="correo@dominio.com" />
										<div class="form-check form-switch mt-1">
											<input class="form-check-input" type="checkbox" id="switchEmail" formControlName="email_habilitado" />
											<label class="form-check-label" for="switchEmail">Habilitar edición de email</label>
										</div>
									</div>
									<div class="col-12">
										<label class="form-label">Método de Pago</label>
										<select class="form-select" formControlName="id_forma_cobro" [ngClass]="{'is-invalid': isFormaCobroInvalid}">
											<option value="">-- Seleccione --</option>
											<option *ngFor="let f of formasCobro" [value]="f.id_forma_cobro">{{ f.nombre }}</option>
										</select>
										<div class="invalid-feedback">Seleccione un método de pago (por ahora solo EFECTIVO).</div>
									</div>
								</div>
							</div>

							<!-- Fin columnas -->

							<!-- Otros campos -->
							<div class="col-md-3">
								<label class="form-label">Cuenta bancaria</label>
								<input class="form-control" formControlName="id_cuentas_bancarias" placeholder="ID numérico" />
							</div>
							<div class="col-md-3">
								<label class="form-label">ID Usuario</label>
								<input class="form-control" formControlName="id_usuario" placeholder="ID numérico" />
							</div>
						</div>

						<hr />

						<div formArrayName="pagos">
							<div class="table-responsive">
								<table class="table table-sm table-bordered align-middle">
									<thead class="table-light">
										<tr>
											<th>Cant.</th>
											<th>Detalle</th>
											<th>P/U</th>
											<th>Descuento</th>
											<th>Sub total</th>
											<th>M</th>
											<th>D</th>
											<th>Obs.</th>
											<th></th>
										</tr>
									</thead>
									<tbody>
										<tr *ngFor="let pg of pagos.controls; let i = index" [formGroupName]="i">
											<td>{{ i + 1 }}</td>
											<td><input class="form-control form-control-sm" formControlName="nro_cobro" /></td>
											<td><input class="form-control form-control-sm" formControlName="id_cuota" /></td>
											<td><input class="form-control form-control-sm" formControlName="id_item" /></td>
											<td><input type="number" step="0.01" class="form-control form-control-sm" formControlName="monto" /></td>
											<td><input type="date" class="form-control form-control-sm" formControlName="fecha_cobro" /></td>
											<td><input class="form-control form-control-sm" formControlName="observaciones" /></td>
											<td class="text-center">
												<button type="button" class="btn btn-sm btn-outline-danger" (click)="removePago(i)"><i class="bi bi-trash"></i></button>
											</td>
										</tr>
									</tbody>
								</table>
							</div>
						</div>

						<div class="d-flex justify-content-end">
							<button class="btn btn-success" [disabled]="loading" type="submit">
								<i class="bi bi-save me-1"></i> Guardar Lote
							</button>
						</div>
					</form>
				</div>
			</div>
		</div>
		<div class="col-12 col-lg-4">
			<div class="card mb-4 shadow-sm">
				<div class="card-header d-flex justify-content-between align-items-center">
					<strong>Opciones de cobro</strong>
					<div class="d-flex gap-2">
						<button type="button" class="btn btn-sm btn-outline-secondary" (click)="limpiarOpcionesCobro()" [disabled]="!resumen"><i class="bi bi-eraser me-1"></i> Limpiar</button>
						<button type="button" class="btn btn-sm btn-outline-primary" (click)="recargarOpcionesCobro()" [disabled]="!resumen"><i class="bi bi-arrow-repeat me-1"></i> Actualizar</button>
					</div>
				</div>
				<div class="card-body">
					<ng-container *ngIf="showOpciones; else opcionesVacias">
					<div class="table-responsive">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>Artículo</th>
									<th>Precio</th>
									<th class="text-center">Añadir</th>
								</tr>
							</thead>
							<tbody>
								<tr>
									<td>Mensualidad</td>
									<td>{{ resumen?.totales?.pu_mensual | number:'1.2-2' }}</td>
									<td class="text-center">
										<button type="button" class="btn btn-sm btn-success" (click)="openMensualidadModal()"><i class="bi bi-plus"></i></button>
									</td>
								</tr>
								<tr>
									<td>Rezagado</td>
									<td>-</td>
									<td class="text-center">
										<button type="button" class="btn btn-sm btn-success" (click)="openRezagadoModal()"><i class="bi bi-plus"></i></button>
									</td>
								</tr>
								<tr>
									<td>Prueba de Recuperación</td>
									<td>-</td>
									<td class="text-center">
										<button type="button" class="btn btn-sm btn-success" (click)="openRecuperacionModal()"><i class="bi bi-plus"></i></button>
									</td>
								</tr>
							</tbody>
						</table>
					</div>

					<hr class="my-4"/>

					<div>
						<h6 class="mb-3 border-bottom pb-2">Totales</h6>
        				<div class="row">
          					<div class="col-12">
            					<div class="d-flex justify-content-between align-items-center mb-2">
             				 	<span class="fw-medium">Monto Semestral:</span>
								<strong class="text-end">{{ resumen?.totales?.monto_semestral | number: '1.2-2' }}</strong>
							</div>
							<div class="d-flex justify-content-between align-items-center mb-2">
             				 	<span class="fw-medium">Total Pagado:</span>
            				  	<strong class="text-success">{{ resumen?.totales?.total_pagado | number: '1.2-2' }}</strong>
           				 	</div>
           				 	<div class="d-flex justify-content-between align-items-center">
             				 	<span class="fw-medium">Saldo Mensualidad:</span>
              					<strong class="text-danger">{{ resumen?.totales?.saldo_mensualidad | number: '1.2-2' }}</strong>
           				 	</div>
       				    </div>
					</div>
					</div>
					</ng-container>
					<ng-template #opcionesVacias>
						<div class="text-muted small">Ingrese un código y consulte para ver las opciones de cobro.</div>
					</ng-template>
				</div>
			</div>
			<!-- Fin resumen -->
			<!-- Kardex económico -->
			<div class="kardex-card card mb-4 shadow-sm">
				<div class="card-header d-flex justify-content-between align-items-center">
					<strong>Datos del Estudiante</strong>
					<button type="button" class="btn btn-sm btn-outline-primary" [disabled]="!resumen" (click)="openKardexModal()">
						<i class="bi bi-journal-text me-1"></i>Kardex económico
					</button>
				</div>
				<div class="card-body">
					<form [formGroup]="searchForm" (ngSubmit)="loadResumen()">
						<div class="col-mb-4">
							<label class="form-label">Código CETA</label>
							<input class="form-control" formControlName="cod_ceta" placeholder="Ej: 20201234" />
						</div>
						<div class="col-mb-4">
							<label class="form-label">Gestión (opcional)</label>
							<select class="form-select" formControlName="gestion">
								<option value="">-- Seleccione --</option>
								<option *ngFor="let g of gestiones" [value]="g.gestion">{{ g.gestion }}</option>
							</select>
						</div>
						<div class="d-grid">
							<button class="btn btn-primary py-2" [disabled]="loading" type="submit">
								<i class="bi bi-search me-2"></i> Consultar
							</button>
						</div>
					</form>

					<hr class="my-4"/>

					<div *ngIf="resumen as r">
						<h6 class="mb-3 border-bottom pb-2">Totales</h6>
        				<div class="row">
          					<div class="col-12">
            					<div class="d-flex justify-content-between align-items-center mb-2">
             				 	<span class="fw-medium">Monto Semestral:</span>
								<strong class="text-end">{{ r?.totales?.monto_semestral | number: '1.2-2' }}</strong>
							</div>
							<div class="d-flex justify-content-between align-items-center mb-2">
             				 	<span class="fw-medium">Total Pagado:</span>
            				  	<strong class="text-success">{{ r?.totales?.total_pagado | number: '1.2-2' }}</strong>
           				 	</div>
           				 	<div class="d-flex justify-content-between align-items-center">
             				 	<span class="fw-medium">Saldo Mensualidad:</span>
              					<strong class="text-danger">{{ r?.totales?.saldo_mensualidad | number: '1.2-2' }}</strong>
           				 	</div>
          				</div>
       				 </div>
					<div *ngIf="!resumen" class="text-muted small">Ingrese un código y consulte para ver el resumen.</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal: Razón social / Documento -->
	<div class="modal fade" id="razonSocialModal" tabindex="-1" aria-labelledby="razonSocialModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="razonSocialModalLabel">Razón social</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<!-- Alertas del modal -->
					<div *ngIf="modalAlertMessage" class="alert mb-3" [ngClass]="{
						'alert-success': modalAlertType === 'success',
						'alert-danger': modalAlertType === 'error',
						'alert-warning': modalAlertType === 'warning'
					}">{{ modalAlertMessage }}</div>

					<!-- Panel verde con cabecera azul -->
					<div class="p-3 bg-success bg-opacity-10 rounded">
						<div class="border rounded">
							<div class="bg-primary text-white px-3 py-2 rounded-top">
								<strong>Búsqueda de NIT y Razón Social:</strong>
							</div>
							<div class="p-3">
								<form [formGroup]="modalIdentidadForm" class="row g-3 align-items-center">
									<div class="col-md-6">
										<label class="form-label fw-semibold text-success">Tipo de Identidad</label>
										<select class="form-select" formControlName="tipo_identidad">
											<option [ngValue]="1">CI - CEDULA DE IDENTIDAD</option>
											<option [ngValue]="2">CEX - CEDULA DE IDENTIDAD DE EXTRANJERO</option>
											<option [ngValue]="3">PAS - PASAPORTE</option>
											<option [ngValue]="4">OD - OTRO DOCUMENTO DE IDENTIDAD</option>
											<option [ngValue]="5">NIT - NUMERO DE IDENTIFICACION TRIBUTARIA</option>
										</select>
									</div>
									<div class="col-md-6">
										<label class="form-label fw-semibold text-success">{{ docLabel }}</label>
										<div class="input-group">
											<input class="form-control" formControlName="ci" [placeholder]="docPlaceholder" />
											<button class="btn btn-outline-primary" type="button" (click)="buscarPorCI()">
												<i class="bi bi-search"></i>
											</button>
										</div>
									</div>

									<!-- Complemento solo para CI -->
									<div class="col-md-6" *ngIf="showComplemento">
										<div class="form-check mb-1">
											<input class="form-check-input" type="checkbox" id="chkComp" formControlName="complemento_habilitado" />
											<label class="form-check-label" for="chkComp">Complemento ci</label>
										</div>
										<input class="form-control" formControlName="complemento_ci" placeholder="Ej: 1A" />
									</div>

									<div class="col-md-6">
										<label class="form-label fw-semibold text-success">Razón Social</label>
										<div class="input-group">
											<input class="form-control" formControlName="razon_social" [readonly]="!razonSocialEditable" />
											<button class="btn btn-outline-secondary" type="button" (click)="editRazonSocial()" [disabled]="razonSocialEditable">
												<i class="bi bi-pencil"></i>
											</button>
										</div>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" (click)="guardarRazonSocial()" [disabled]="loading">
						<i class="bi bi-check2 me-1"></i> Grabar y Salir
					</button>
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Modal: Kardex Económico -->
	<div class="modal fade" id="kardexModal" tabindex="-1" aria-labelledby="kardexModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-xl modal-dialog-scrollable">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="kardexModalLabel">Kardex económico</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body" *ngIf="resumen as r">
					<div class="row g-3 mb-3">
						<div class="col-md-6">
							<div class="small text-muted">{{ r?.estudiante?.cod_ceta }} - {{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres }}</div>
							<div class="small">Pensum: {{ r?.inscripcion?.cod_pensum }} | Tipo: {{ r?.inscripcion?.tipo_inscripcion }}</div>
						</div>
						<div class="col-md-6">
							<ul class="list-unstyled mb-0">
								<li>Monto Semestral: <strong>{{ r?.totales?.monto_semestral | number:'1.2-2' }}</strong></li>
								<li>Total Pagado: <strong class="text-success">{{ r?.totales?.total_pagado | number:'1.2-2' }}</strong></li>
								<li>Saldo Mensualidad: <strong class="text-danger">{{ r?.totales?.saldo_mensualidad | number:'1.2-2' }}</strong></li>
							</ul>
						</div>
					</div>

					<h6 class="mb-2">Mensualidades</h6>
					<div class="table-responsive mb-4">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>Fecha</th>
									<th>Nro Cobro</th>
									<th>Cuota</th>
									<th>Monto</th>
									<th>Forma</th>
									<th>Obs.</th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let m of (r?.cobros?.mensualidad?.items || [])">
									<td>{{ m?.fecha_cobro | date:'yyyy-MM-dd' }}</td>
									<td>{{ m?.nro_cobro }}</td>
									<td>{{ m?.id_cuota ? ('Cuota ' + m?.id_cuota) : '-' }}</td>
									<td>{{ m?.monto | number:'1.2-2' }}</td>
									<td>{{ m?.id_forma_cobro }}</td>
									<td>{{ m?.observaciones }}</td>
								</tr>
							</tbody>
							<tfoot>
								<tr>
									<th colspan="3" class="text-end">Total</th>
									<th>{{ r?.cobros?.mensualidad?.total | number:'1.2-2' }}</th>
									<th colspan="2"></th>
								</tr>
							</tfoot>
						</table>
					</div>

					<h6 class="mb-2">Items</h6>
					<div class="table-responsive">
						<table class="table table-sm table-bordered align-middle">
							<thead class="table-light">
								<tr>
									<th>Fecha</th>
									<th>Nro Cobro</th>
									<th>Item</th>
									<th>Monto</th>
									<th>Forma</th>
									<th>Obs.</th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let it of (r?.cobros?.items?.items || [])">
									<td>{{ it?.fecha_cobro | date:'yyyy-MM-dd' }}</td>
									<td>{{ it?.nro_cobro }}</td>
									<td>{{ it?.id_item || '-' }}</td>
									<td>{{ it?.monto | number:'1.2-2' }}</td>
									<td>{{ it?.id_forma_cobro }}</td>
									<td>{{ it?.observaciones }}</td>
								</tr>
							</tbody>
							<tfoot>
								<tr>
									<th colspan="3" class="text-end">Total</th>
									<th>{{ r?.cobros?.items?.total | number:'1.2-2' }}</th>
									<th colspan="2"></th>
								</tr>
							</tfoot>
						</table>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
				</div>
			</div>
		</div>
	</div>

    <!-- Modal: Mensualidades / Rezagado / Recuperación (componente) -->
    <app-mensualidad-modal
      [resumen]="resumen"
      [formasCobro]="formasCobro"
      [tipo]="modalTipo"
      [pendientes]="mensualidadesPendientes"
      [pu]="mensualidadPU"
      [baseNro]="getNextMensualidadNro()"
      [defaultMetodoPago]="selectedFormaCobroId"
      (addPagos)="onAddPagosFromModal($event)"
    ></app-mensualidad-modal>
