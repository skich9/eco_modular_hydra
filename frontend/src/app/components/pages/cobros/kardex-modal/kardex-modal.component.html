<div class="modal fade" id="kardexModal" tabindex="-1" aria-labelledby="kardexModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="kardexModalLabel">Kardex económico</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" *ngIf="resumen as r">
				<!-- Información Biográfica del Postulante -->
				<div class="card mb-4">
					<div class="card-header bg-primary text-white">
						<h6 class="mb-0">Información Biográfica del Postulante</h6>
					</div>
					<div class="card-body">
						<div class="row g-3">
							<div class="col-md-3">
								<label class="form-label small text-muted">Código CETA</label>
								<div class="fw-bold">{{ r?.estudiante?.cod_ceta || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Nombre Completo</label>
								<div class="fw-bold">{{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Cédula</label>
								<div class="fw-bold">{{ r?.estudiante?.cedula || r?.estudiante?.ci || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Email</label>
								<div class="fw-bold">{{ r?.estudiante?.email || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Carrera</label>
								<div class="fw-bold">{{ r?.estudiante?.carrera || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Resolución</label>
								<div class="fw-bold">{{ r?.estudiante?.resolucion || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Gestión</label>
								<div class="fw-bold">{{ r?.estudiante?.gestion || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Grupos</label>
								<div class="fw-bold">{{ r?.estudiante?.grupos || '-' }}</div>
							</div>
							<div class="col-md-3">
								<label class="form-label small text-muted">Descuento</label>
								<div class="fw-bold">{{ r?.estudiante?.descuento || '-' }}</div>
							</div>
							<div class="col-md-6">
								<label class="form-label small text-muted">Observaciones</label>
								<div class="fw-bold">{{ r?.estudiante?.observaciones || '-' }}</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Resumen Financiero -->
				<div class="row g-3 mb-3">
					<div class="col-md-6">
						<div class="small text-muted">{{ r?.estudiante?.cod_ceta }} - {{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres }}</div>
						<div class="small">Pensum: {{ r?.inscripcion?.cod_pensum }} | Tipo: {{ r?.inscripcion?.tipo_inscripcion }}</div>
					</div>
					<div class="col-md-6">
						<ul class="list-unstyled mb-0">
							<li>Monto Semestral: <strong>{{ r?.totales?.monto_semestral | number:'1.2-2' }}</strong></li>
							<li>Total Pagado: <strong class="text-success">{{ r?.totales?.total_pagado | number:'1.2-2' }}</strong></li>
							<li>Saldo Mensualidad: <strong class="text-danger">{{ r?.totales?.saldo_mensualidad | number:'1.2-2' }}</strong></li>
						</ul>
					</div>
				</div>

				<!-- Mensualidades Pagadas -->
				<div class="card mb-4">
					<div class="card-header bg-success text-white">
						<h6 class="mb-0">Mensualidades Pagadas</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle">
								<thead class="table-light">
									<tr>
										<th>Tipo</th>
										<th>Cuota</th>
										<th>Pago</th>
										<th>Monto</th>
										<th>Factura</th>
										<th>Recibo</th>
										<th>Total</th>
										<th>Fecha</th>
										<th>Razón Social / NIT</th>
										<th>Obs.</th>
									</tr>
								</thead>
								<tbody>
									<tr *ngFor="let m of (r?.mensualidades?.pagadas || [])">
										<td>{{ 'NORMAL' }}</td>
										<td>{{ m?.numero_cuota || '1' }}</td>
										<td>{{ '1' }}</td>
										<td>
											<ng-container [ngSwitch]="m?.estado_pago">
												<ng-container *ngSwitchCase="'PARCIAL'">
													{{ m?.monto_pagado | number:'1.0-0' }}
												</ng-container>
												<ng-container *ngSwitchDefault>
													{{ m?.monto_pagado | number:'1.0-0' }}
												</ng-container>
											</ng-container>
										</td>
										<td>{{ m?.nro_factura || '-' }}</td>
										<td>{{ m?.nro_recibo || '0' }}</td>
										<td>{{ m?.es_completo || 'No' }}</td>
										<td>{{ (m?.fecha_pago | date:'dd/MM/yyyy') || '-' }}</td>
										<td>{{ r?.estudiante?.razon_social || (r?.estudiante?.ap_paterno + ' / ' + r?.estudiante?.ci) || '-' }}</td>
										<td>{{ m?.observaciones || 'Efectivo:' }}</td>
									</tr>
								</tbody>
								<tfoot>
									<tr>
										<th colspan="8" class="text-end">Total Pagado</th>
										<th class="text-success">{{ r?.cobros?.mensualidad?.total | number:'1.0-0' }}</th>
										<th colspan="2"></th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>

				<!-- Mensualidades Adeudadas -->
				<div class="card mb-4">
					<div class="card-header bg-danger text-white">
						<h6 class="mb-0">Mensualidades Adeudadas</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle">
								<thead class="table-light">
									<tr>
										<th>Tipo</th>
										<th>Cuota</th>
										<th>Monto</th>
										<th>Dias Mora</th>
										<th>Importe por Mora</th>
										<th>Descuento en Mora</th>
										<th>Monto Adeudado</th>
										<th>Monto Acumulado</th>
										<th>Fecha de vencimiento</th>
										<th>Observaciones</th>
									</tr>
								</thead>
								<tbody>
									<ng-container *ngFor="let m of (r?.mensualidades?.adeudadas || []); let i = index">
									<tr>
										<td>{{ 'NORMAL' }}</td>
										<td>{{ m?.numero_cuota || (i + 1) }}</td>
										<td>
											<ng-container [ngSwitch]="m?.estado_pago">
												<ng-container *ngSwitchCase="'PARCIAL'">
													<!-- Mostrar saldo restante para pagos parciales -->
													{{ ((m?.monto || 0) - (m?.monto_pagado || 0)) | number:'1.0-0' }}
												</ng-container>
												<ng-container *ngSwitchDefault>
													{{ m?.monto | number:'1.0-0' }}
												</ng-container>
											</ng-container>
										</td>
										<td>{{ calculateDaysOverdue(m?.fecha_vencimiento) }}</td>
										<td>{{ calculateDaysOverdue(m?.fecha_vencimiento) > 0 ? calculateDaysOverdue(m?.fecha_vencimiento) : '0' }}</td>
										<td>{{ '0' }}</td>
										<td class="align-text-end">
											<ng-container [ngSwitch]="m?.estado_pago">
												<ng-container *ngSwitchCase="'PARCIAL'">
													{{ ((m?.monto || 0) - (m?.monto_pagado || 0)) | number:'1.0-0' }}
												</ng-container>
												<ng-container *ngSwitchDefault>
													{{ m?.monto | number:'1.0-0' }}
												</ng-container>
											</ng-container>
										</td>
										<td>{{ calculateCumulativeAmount(r?.mensualidades?.adeudadas, i) | number:'1.0-0' }}</td>
										<td>{{ (m?.fecha_vencimiento | date:'yyyy-MM-dd') || '-' }}</td>
										<td>{{ '' }}</td>
									</tr>
									</ng-container>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Material Extra -->
				<div class="card mb-4">
					<div class="card-header bg-primary text-white">
						<h6 class="mb-0">Material Extra</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle">
								<thead class="table-light">
									<tr>
										<th>Fecha</th>
										<th>Nro Cobro</th>
										<th>Item</th>
										<th>Descripción</th>
										<th>Monto</th>
										<th>Forma</th>
										<th>Obs.</th>
									</tr>
								</thead>
								<tbody>
									<tr *ngFor="let it of (r?.cobros?.items?.items || [])">
										<td>{{ it?.fecha_cobro | date:'yyyy-MM-dd' }}</td>
										<td>{{ it?.nro_cobro }}</td>
										<td>{{ it?.id_item || '-' }}</td>
										<td>{{ it?.descripcion || it?.id_item || '-' }}</td>
										<td>{{ it?.monto | number:'1.2-2' }}</td>
										<td>{{ it?.id_forma_cobro }}</td>
										<td>{{ it?.observaciones }}</td>
									</tr>
								</tbody>
								<tfoot>
									<tr>
										<th colspan="4" class="text-end">Total Material Extra</th>
										<th class="text-info">{{ r?.cobros?.items?.total | number:'1.2-2' }}</th>
										<th colspan="2"></th>
									</tr>
								</tfoot>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>
