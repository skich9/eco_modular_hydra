<div class="modal fade" id="kardexModal" tabindex="-1" aria-labelledby="kardexModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-xl modal-dialog-scrollable">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="kardexModalLabel">Kardex económico</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body" *ngIf="resumen as r">
				<!-- Información Biográfica del Postulante -->
				<div class="card mb-4">
					<div class="card-header bg-primary text-white">
						<h6 class="mb-0">Información Biográfica del Estudiante</h6>
					</div>
					<div class="card-body">
						<div class="row g-4">
							<!-- Columna izquierda de información biográfica -->
							<div class="col-md-4">
								<div class="h-100">
									<div class="mb-3">
										<label class="form-label small text-muted">Código CETA</label> 
										<div class="fw-bold">{{ r?.estudiante?.cod_ceta || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Nombre Completo</label>
										<div class="fw-bold">{{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Cédula</label>
										<div class="fw-bold">{{ r?.estudiante?.cedula || r?.estudiante?.ci || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Email</label>
										<div class="fw-bold">{{ r?.estudiante?.email || '-' }}</div>
									</div>
								</div>
							</div>

							<!-- Columna central de información biográfica -->
							<div class="col-md-4">
								<div class="h-100">
									<div class="mb-3">
										<label class="form-label small text-muted">Carrera</label>
										<div class="fw-bold">{{ r?.estudiante?.carrera || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Resolución</label>
										<div class="fw-bold">{{ r?.estudiante?.resolucion || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Gestión</label>
										<div class="fw-bold">{{ r?.estudiante?.gestion || '-' }}</div>
									</div>
									<div class="mb-3">
										<label class="form-label small text-muted">Grupos</label>
										<div class="d-flex flex-column gap-1">
											<div class="d-flex align-items-center gap-2" *ngFor="let ins of (r?.inscripciones || [])">
												<span class="badge rounded-pill bg-primary">{{ ins?.cod_curso || '-' }}</span>
												<span class="badge rounded-pill bg-warning text-dark">{{ (ins?.tipo_inscripcion || '-').toUpperCase() }}</span>
											</div>
										</div>
									</div>
								</div>
							</div>

							<!-- Columna derecha reservada para foto del estudiante -->
							<div class="col-md-4">
								<div class="student-photo-placeholder">
									<div class="text-center text-muted">
										<i class="fas fa-user-circle fa-5x mb-3"></i>
										<p class="mb-2 small fw-semibold">Espacio para foto del estudiante</p>
										<p class="mb-0 small text-secondary">Aquí se añadirá la foto</p>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="card-footer bg-light">
						<div class="row">
							<div class="col-md-6">
								<div class="small">
									<span class="text-muted">Descuento:</span>
									<span class="fw-bold">{{ r?.estudiante?.descuento || '-' }}</span>
								</div>
							</div>
							<div class="col-md-6">
								<div class="small">
									<span class="text-muted">Observaciones:</span>
									<span class="fw-bold">{{ r?.estudiante?.observaciones || '-' }}</span>
								</div>
							</div>
						</div>
					</div>
				</div>

				<!-- Resumen Financiero -->
				<div class="financial-summary mb-4">
					<div class="row g-3">
						<div class="col-md-6">
							<div class="student-info">
								<div class="fw-semibold">{{ r?.estudiante?.cod_ceta }} - {{ r?.estudiante?.nombre_completo || r?.estudiante?.nombres }}</div>
								<div class="small">Pensum: {{ r?.inscripcion?.cod_pensum }} | Tipo: {{ r?.inscripcion?.tipo_inscripcion }}</div>
							</div>
						</div>
						<div class="col-md-6">
							<ul class="financial-details">
								<li>
									<span class="text-muted">Monto Semestral:</span>
									<strong class="float-end">{{ r?.totales?.monto_semestral | number:'1.2-2' }}</strong>
								</li>
								<li>
									<span class="text-muted">Total Pagado:</span>
									<strong class="text-success float-end">{{ r?.totales?.total_pagado_v2 | number:'1.2-2' }}</strong>
								</li>
								<li>
									<span class="text-muted">Saldo Mensualidad:</span>
									<strong class="text-danger float-end">{{ r?.totales?.saldo_mensualidad | number:'1.2-2' }}</strong>
								</li>
							</ul>
						</div>
					</div>
				</div>

				<!-- Mensualidades Pagadas -->
				<div class="card mb-4">
					<div class="card-header bg-success text-white">
						<h6 class="mb-0">Mensualidades Pagadas</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle pagos-table">
								<thead class="table-light">
									<tr>
										<th>Tipo</th>
										<th>Cuota</th>
										<th>Pago</th>
										<th>Monto</th>
										<th>Factura</th>
										<th>Recibo</th>
										<th>Pago Total</th>
										<th>Fecha</th>
										<th>Razón Social / NIT</th>
										<th>Tipo de Pago</th>
										<th>Observaciones</th>
									</tr>
								</thead>
								<tbody>
									<tr *ngFor="let m of getPagosExpandidos()">
										<td class="text-center">{{ (m?.tipo_inscripcion || 'NORMAL').toUpperCase() }}</td>
										<td class="text-center">{{ getCuotaFormat(m?.numero_cuota || 1) }}</td>
										<td class="text-center">{{ m?.numero_pago || 1 }}</td>
										<td class="text-center">
											<ng-container [ngSwitch]="m?.estado_pago">
												<ng-container *ngSwitchCase="'PARCIAL'">
													<span class="status-indicator pending">{{ m?.monto_pagado | number:'1.0-0' }}</span>
												</ng-container>
												<ng-container *ngSwitchDefault>
													<span class="status-indicator paid">{{ m?.monto_pagado | number:'1.0-0' }}</span>
												</ng-container>
											</ng-container>
										</td>
										<td class="text-center">{{ m?.nro_factura || '-' }}</td>
										<td class="text-center">{{ m?.nro_recibo || '0' }}</td>
										<td class="text-center">
											<span [ngClass]="m?.es_completo === 'Si' ? 'badge bg-success' : 'badge bg-warning text-dark'">
												{{ m?.es_completo === 'Si' ? 'Completo' : 'Parcial' }}
											</span>
										</td>
										<td class="text-center">{{ (m?.fecha_pago | date:'dd/MM/yyyy') || '-' }}</td>
										<td>{{ m?.razon_social || '-' }} {{ m?.nit ? '/' + m.nit : '' }}</td>
										<td class="text-center">{{ getNombreFormaCobro(m?.id_forma_cobro) }}</td>
										<td>{{ getObservacionesExtendidas(m) }}</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Mensualidades Adeudadas -->
				<div class="card mb-4">
					<div class="card-header bg-danger text-white">
						<h6 class="mb-0">Mensualidades Adeudadas</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle adeudadas-table">
								<thead class="table-light">
									<tr>
										<th>Tipo</th>
										<th>Cuota</th>
										<th>Monto</th>
										<th>Dias Mora</th>
										<th>Importe por Mora</th>
										<th>Descuento en Mora</th>
										<th>Monto Adeudado</th>
										<th>Monto Acumulado</th>
										<th>Fecha de vencimiento</th>
										<th>Observaciones</th>
									</tr>
								</thead>
								<tbody>
									<ng-container *ngFor="let m of (r?.mensualidades?.adeudadas || []); let i = index">
									<tr>
										<td class="text-center">{{ (m?.tipo_inscripcion || 'NORMAL').toUpperCase() }}</td>
										<td class="text-center">{{ getCuotaFormat(m?.numero_cuota || (i + 1)) }}</td>
										<td class="text-end">
											<span class="status-indicator overdue">
												<ng-container [ngSwitch]="m?.estado_pago">
													<ng-container *ngSwitchCase="'PARCIAL'">
														<!-- Mostrar saldo restante para pagos parciales -->
														{{ ((m?.monto || 0) - (m?.monto_pagado || 0)) | number:'1.0-0' }}
													</ng-container>
													<ng-container *ngSwitchDefault>
														{{ m?.monto | number:'1.0-0' }}
													</ng-container>
												</ng-container>
											</span>
										</td>
										<td class="text-center">
											<span class="badge {{ calculateDaysOverdue(m?.fecha_vencimiento) > 0 ? 'bg-danger' : 'bg-secondary' }}">
												{{ calculateDaysOverdue(m?.fecha_vencimiento) }}
											</span>
										</td>
										<td class="text-end">{{ calculateDaysOverdue(m?.fecha_vencimiento) > 0 ? calculateDaysOverdue(m?.fecha_vencimiento) : '0' }}</td>
										<td class="text-center">{{ '0' }}</td>
										<td class="text-end">
											<ng-container [ngSwitch]="m?.estado_pago">
												<ng-container *ngSwitchCase="'PARCIAL'">
													{{ ((m?.monto || 0) - (m?.monto_pagado || 0)) | number:'1.0-0' }}
												</ng-container>
												<ng-container *ngSwitchDefault>
													{{ m?.monto | number:'1.0-0' }}
												</ng-container>
											</ng-container>
										</td>
										<td class="text-end">{{ calculateCumulativeAmount(r?.mensualidades?.adeudadas, i) | number:'1.0-0' }}</td>
										<td class="text-center">{{ (m?.fecha_vencimiento | date:'yyyy-MM-dd') || '-' }}</td>
										<td>{{ '' }}</td>
									</tr>
									</ng-container>
								</tbody>
							</table>
						</div>
					</div>
				</div>

				<!-- Matrícula o Reincorporación -->
				<div class="card mb-4">
					<div class="card-header bg-info text-white">
						<h6 class="mb-0">Matrícula o Reincorporación</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle reincorporacion-table">
								<thead class="table-light">
									<tr>
										<th class="text-center">Pago</th>
										<th class="text-end">Monto</th>
										<th class="text-center">Factura</th>
										<th class="text-center">Recibo</th>
										<th class="text-center">Pago Total</th>
										<th class="text-center">Fecha</th>
										<th>Razón Social / NIT</th>
										<th>Obs.</th>
									</tr>
								</thead>
								<tbody>
									<tr *ngFor="let it of (r?.cobros?.items | filterReincorporacion); let i = index">
										<td class="text-center">{{ i + 1 }}</td>
										<td class="text-end">
											<span class="status-indicator paid">
												{{ it?.monto | number:'1.0-0' }}
											</span>
										</td>
										<td class="text-center">{{ it?.nro_factura || '-' }}</td>
										<td class="text-center">{{ it?.nro_recibo || '-' }}</td>
										<td class="text-center">
											<span class="badge bg-success">Completo</span>
										</td>
										<td class="text-center">{{ it?.fecha_cobro | date:'dd/MM/yyyy' }}</td>
										<td>{{ it?.razon_social || '-' }} {{ it?.nit ? '/' + it.nit : '' }}</td>
										<td>{{ getObservacionesExtendidas(it) }}</td>
									</tr>
									<tr *ngIf="(r?.cobros | filterReincorporacion)?.length === 0" class="text-center">
										<td colspan="8" class="text-muted py-3">
											No hay registros de matrícula o reincorporación
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
				
				<!-- Material Extra -->
				<div class="card mb-4">
					<div class="card-header bg-primary text-white">
						<h6 class="mb-0">Material Extra</h6>
					</div>
					<div class="card-body">
						<div class="table-responsive">
							<table class="table table-sm table-bordered align-middle material-table">
								<thead class="table-light">
									<tr>
										<th class="text-center">Nº</th>
                        				<th>Concepto</th>
                        				<th class="text-end">Monto</th>
                        				<th class="text-center">Factura</th>
                        				<th class="text-center">Recibo</th>
                        				<th class="text-center">Fecha</th>
                        				<th>Razón Social / NIT</th>
                        				<th>Método de Pago</th>
									</tr>
								</thead>
								<tbody>
									<tr *ngFor="let it of (r?.cobros?.items | filterNonMensualidades); let i = index">
										<td class="text-center">{{ i + 1 }}</td>
                        				<td>{{ it?.concepto || 'Material Extra' }}</td>
                        				<td class="text-end">
											<span class="status-indicator paid">
												{{ it?.monto | number:'1.0-0' }}
											</span>
										</td>
                        				<td class="text-center">{{ it?.nro_factura || '0' }}</td>
                        				<td class="text-center">{{ it?.nro_recibo || '0' }}</td>
                        				<td class="text-center">{{ it?.fecha_cobro | date:'dd/MM/yyyy' }}</td>
                        				<td>{{ it?.razon_social || '-' }} {{ it?.nit ? '/' + it.nit : '' }}</td>
                        				<td class="text-center">{{ getNombreFormaCobro(it?.id_forma_cobro) }}</td>
									</tr>
									<tr *ngIf="(r?.cobros | filterNonMensualidades)?.length === 0" class="text-center">
										<td colspan="8" class="text-muted py-3">
											No hay registros de material extra
										</td>
									</tr>
								</tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>
