<div class="modal fade" id="moraModal" tabindex="-1" aria-labelledby="moraModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="moraModalLabel">Pago de Mora</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div class="p-3 bg-primary bg-opacity-10 rounded mb-3">
					<div class="row g-3 align-items-center" [formGroup]="form">
						<div class="col-md-8">
							<div class="d-flex justify-content-between align-items-center">
								<div class="small fw-semibold">Datos del Estudiante</div>
								<div class="small fw-semibold text-danger">Total Mora: {{ totalMorasPendientes | number:'1.2-2' }} Bs</div>
							</div>
							<div class="small text-muted">{{ resumen?.estudiante?.cod_ceta }} - {{ resumen?.estudiante?.nombre_completo || resumen?.estudiante?.nombres }}</div>
							<div class="small">
								Pensum: {{ resumen?.inscripcion?.cod_pensum }} | Tipo: {{ resumen?.inscripcion?.tipo_inscripcion }}
							</div>
							<div class="small">Gestión: {{ resumen?.gestion }}</div>
						</div>
						<div class="col-md-4">
							<label class="form-label">Método de Pago</label>
							<select class="form-select" formControlName="metodo_pago" [class.is-invalid]="form.get('metodo_pago')?.invalid && (form.get('metodo_pago')?.touched || form.get('metodo_pago')?.dirty)">
								<option value="">-- Seleccione --</option>
								<option *ngFor="let f of formasCobro" [value]="f.id_forma_cobro">{{ labelForma(f) }}</option>
							</select>
							<div class="invalid-feedback">Seleccione un método de pago</div>
						</div>
					</div>
				</div>

				<div *ngIf="modalAlertMessage" class="alert" [ngClass]="{
					'alert-warning': modalAlertType === 'warning',
					'alert-danger': modalAlertType === 'error',
					'alert-success': modalAlertType === 'success'
				}">
					{{ modalAlertMessage }}
				</div>

				<form [formGroup]="form" class="row g-3">
					<!-- Tipo de registro y Comprobante -->
					<div class="col-md-4">
						<label class="form-label">Tipo de registro</label>
						<div class="d-flex align-items-center gap-3">
							<div class="form-check">
								<input class="form-check-input" type="radio" id="compu_mora" value="COMPUTARIZADA" formControlName="computarizada" />
								<label class="form-check-label" for="compu_mora">Computarizada</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="radio" id="manual_mora" value="MANUAL" formControlName="computarizada" />
								<label class="form-check-label" for="manual_mora">Manual</label>
							</div>
						</div>
					</div>

					<div class="col-md-4">
						<label class="form-label">Comprobante</label>
						<div class="d-flex align-items-center gap-3">
							<div class="form-check">
								<input class="form-check-input" type="radio" id="comp_recibo_mora" value="RECIBO" formControlName="comprobante" />
								<label class="form-check-label" for="comp_recibo_mora">Recibo</label>
							</div>
							<div class="form-check">
								<input class="form-check-input" type="radio" id="comp_factura_mora" value="FACTURA" formControlName="comprobante" [disabled]="facturaDeshabilitada" />
								<label class="form-check-label" for="comp_factura_mora" [class.text-muted]="facturaDeshabilitada">Factura</label>
							</div>
						</div>
					</div>

					<div class="col-md-4 d-flex align-items-center">
						<div class="form-check">
							<input class="form-check-input" type="checkbox" id="pagoParcialMora" formControlName="pago_parcial" />
							<label class="form-check-label" for="pagoParcialMora">Pago Parcial</label>
						</div>
					</div>

					<!-- Datos de Tarjeta -->
					<ng-container *ngIf="isTarjeta">
						<div class="col-12">
							<div class="border rounded p-3 mb-2">
								<div class="row g-3 align-items-end">
									<div class="col-md-4">
										<label class="form-label">Banco Origen</label>
										<input class="form-control" formControlName="banco_origen" placeholder="Banco origen" [class.is-invalid]="form.get('banco_origen')?.invalid && (form.get('banco_origen')?.touched || form.get('banco_origen')?.dirty)" />
										<div class="invalid-feedback">Ingrese el banco de origen</div>
									</div>
									<div class="col-md-2">
										<label class="form-label">Nº Tarjeta (4 primeros)</label>
										<input class="form-control" maxlength="4" formControlName="tarjeta_first4" placeholder="4" [class.is-invalid]="form.get('tarjeta_first4')?.invalid && (form.get('tarjeta_first4')?.touched || form.get('tarjeta_first4')?.dirty)" />
										<div class="invalid-feedback">Ingrese 4 dígitos</div>
									</div>
									<div class="col-md-2">
										<label class="form-label">Nº Tarjeta (4 últimos)</label>
										<input class="form-control" maxlength="4" formControlName="tarjeta_last4" placeholder="4" [class.is-invalid]="form.get('tarjeta_last4')?.invalid && (form.get('tarjeta_last4')?.touched || form.get('tarjeta_last4')?.dirty)" />
										<div class="invalid-feedback">Ingrese 4 dígitos</div>
									</div>
									<div class="col-md-4">
										<label class="form-label">Cuenta destino</label>
										<select class="form-select" formControlName="id_cuentas_bancarias" [class.is-invalid]="form.get('id_cuentas_bancarias')?.invalid && (form.get('id_cuentas_bancarias')?.touched || form.get('id_cuentas_bancarias')?.dirty)">
											<option value="">Seleccione cuenta/banco</option>
											<option *ngFor="let c of cuentasBancariasFiltradas" [value]="c.id_cuentas_bancarias">{{ c.banco }} - {{ c.numero_cuenta }}</option>
										</select>
										<div class="invalid-feedback">Seleccione una cuenta destino</div>
									</div>
									<div class="col-md-4">
										<label class="form-label">Fecha depósito</label>
										<input type="date" class="form-control" formControlName="fecha_deposito" [class.is-invalid]="form.get('fecha_deposito')?.invalid && (form.get('fecha_deposito')?.touched || form.get('fecha_deposito')?.dirty)" />
										<div class="invalid-feedback">Ingrese la fecha del depósito</div>
									</div>
									<div class="col-md-4">
										<label class="form-label">Num. depósito</label>
										<input type="text" class="form-control" formControlName="nro_deposito" [class.is-invalid]="form.get('nro_deposito')?.invalid && (form.get('nro_deposito')?.touched || form.get('nro_deposito')?.dirty)" />
										<div class="invalid-feedback">Ingrese el número de depósito</div>
									</div>
								</div>
							</div>
						</div>
					</ng-container>

					<!-- Datos de Cheque / Depósito / Transferencia (excluye QR) -->
					<ng-container *ngIf="showBancarioBlock && !isQR">
						<div class="col-12">
							<div class="border rounded p-3 mb-2">
								<div class="row g-3 align-items-end">
									<div class="col-md-4">
										<label class="form-label">Cuenta destino</label>
										<select class="form-select" formControlName="id_cuentas_bancarias" [class.is-invalid]="form.get('id_cuentas_bancarias')?.invalid && (form.get('id_cuentas_bancarias')?.touched || form.get('id_cuentas_bancarias')?.dirty)">
											<option value="">Seleccione cuenta/banco</option>
											<option *ngFor="let c of cuentasBancariasFiltradas" [value]="c.id_cuentas_bancarias">{{ c.banco }} - {{ c.numero_cuenta }}</option>
										</select>
										<div class="invalid-feedback">Seleccione una cuenta destino</div>
									</div>
									<div class="col-md-4" *ngIf="!isQR">
										<label class="form-label">Fecha depósito</label>
										<input type="date" class="form-control" formControlName="fecha_deposito" [class.is-invalid]="form.get('fecha_deposito')?.invalid && (form.get('fecha_deposito')?.touched || form.get('fecha_deposito')?.dirty)" />
										<div class="invalid-feedback">Ingrese la fecha del depósito</div>
									</div>
									<div class="col-md-4" *ngIf="!isQR">
										<label class="form-label">Num. depósito</label>
										<input type="text" class="form-control" formControlName="nro_deposito" [class.is-invalid]="form.get('nro_deposito')?.invalid && (form.get('nro_deposito')?.touched || form.get('nro_deposito')?.dirty)" />
										<div class="invalid-feedback">Ingrese el número de depósito</div>
									</div>
									<div class="col-md-4" *ngIf="isTransferencia && !isQR">
										<label class="form-label">Banco Origen</label>
										<input type="text" class="form-control" formControlName="banco_origen" placeholder="Banco origen" [class.is-invalid]="form.get('banco_origen')?.invalid && (form.get('banco_origen')?.touched || form.get('banco_origen')?.dirty)" />
										<div class="invalid-feedback">Ingrese el banco de origen</div>
									</div>
								</div>
							</div>
						</div>
					</ng-container>

					<!-- Campos específicos de Mora -->
					<div class="col-md-4">
						<label class="form-label">Precio Unitario (por mora)</label>
						<input class="form-control" [value]="precioUnitario | number:'1.2-2'" readonly />
					</div>

					<div class="col-md-3">
						<label class="form-label">Días de Mora</label>
						<input class="form-control" [value]="diasMora" readonly />
					</div>

					<div class="col-md-5">
						<label class="form-label">Cant. moras a pagar</label>
						<select class="form-select" formControlName="cantidad" [disabled]="form.get('pago_parcial')?.value" [class.is-invalid]="form.get('cantidad')?.invalid && (form.get('cantidad')?.touched || form.get('cantidad')?.dirty)">
							<option *ngFor="let opt of getCantidadOptions()" [ngValue]="opt.value">{{ opt.label }}</option>
						</select>
						<div class="invalid-feedback">Seleccione una cantidad válida</div>
					</div>

					<div class="col-md-4">
						<label class="form-label">Descuento</label>
						<input class="form-control" formControlName="descuento" readonly />
					</div>

					<!-- Monto parcial si está activo -->
					<div class="col-md-4" *ngIf="form.get('pago_parcial')?.value">
						<label class="form-label">Monto parcial mora</label>
						<input type="number" step="1" min="1" class="form-control"
							   [ngClass]="{ 'is-invalid': form.get('monto_parcial')?.hasError('max') && form.get('monto_parcial')?.touched }"
							   formControlName="monto_parcial"
							   placeholder="Ingrese monto parcial" />
						<div class="invalid-feedback" *ngIf="form.get('monto_parcial')?.hasError('max') && form.get('monto_parcial')?.touched">
							El monto ingresado excede el saldo.
						</div>
						<div class="form-text">Mínimo: 1 - Máximo: {{ getParcialMax | number:'1.0-0' }}</div>
					</div>

					<div class="col-md-4">
						<label class="form-label">Total Cobrar</label>
						<input class="form-control" formControlName="costo_total" readonly />
					</div>

					<div class="col-12">
						<label class="form-label">Observaciones</label>
						<textarea class="form-control" rows="2" formControlName="observaciones"></textarea>
					</div>
				</form>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-success" [appClickLock]="true" [lockDuration]="3000" (click)="addAndClose()"><i class="bi bi-plus-circle me-1"></i> Adicionar y Salir</button>
				<button type="button" class="btn btn-secondary" [appClickLock]="true" [lockDuration]="1200" data-bs-dismiss="modal">Cerrar</button>
			</div>
		</div>
	</div>
</div>
