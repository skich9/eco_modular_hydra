<div class="container py-3">
	<div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
		<h1 class="h4 m-0">Configuración de Descuentos</h1>
		<div class="d-flex gap-2 align-items-center">
			<div class="position-relative">
				<input type="text" [(ngModel)]="searchTerm" (input)="onSearch()" class="form-control pe-5" placeholder="Buscar...">
				<button class="btn btn-link position-absolute top-50 end-0 translate-middle-y text-muted" (click)="onSearch()">
					<i class="fas fa-search"></i>
				</button>
			</div>
			<button class="btn btn-primary" *ngIf="activeTab==='descuentos'" (click)="openNewDef()">
				<i class="fas fa-plus me-1"></i> Nuevo Descuento
			</button>
			<button class="btn btn-primary" *ngIf="activeTab==='becas'" (click)="openNewBeca()">
				<i class="fas fa-plus me-1"></i> Nueva Beca
			</button>
		</div>
	</div>

	<ul class="nav nav-tabs mb-3">
		<li class="nav-item">
			<button class="nav-link" [class.active]="activeTab==='descuentos'" (click)="setTab('descuentos')">
				<i class="fas fa-percent me-1"></i> Configuración Descuentos
			</button>
		</li>
		<li class="nav-item">
			<button class="nav-link" [class.active]="activeTab==='becas'" (click)="setTab('becas')">
				<i class="fas fa-graduation-cap me-1"></i> Configuración Becas
			</button>
		</li>
	</ul>

	<!-- Tabla: Definición de Descuentos -->
	<div [hidden]="activeTab!=='descuentos'">
		<div class="table-responsive">
			<table class="table align-middle">
				<thead class="table-light">
					<tr>
						<th>Nro</th>
						<th>Nombre</th>
						<th>Tipo</th>
						<th class="text-end">Valor</th>
						<th>Estado</th>
						<th class="text-nowrap">Acciones</th>
					</tr>
				</thead>
				<tbody>
					<tr *ngFor="let i of defPage">
						<td>{{ i.cod_descuento }}</td>
						<td>
							<div class="fw-semibold">{{ i.nombre_descuento }}</div>
							<div class="text-muted small" *ngIf="i.descripcion">{{ i.descripcion }}</div>
						</td>
						<td>
							<span class="badge bg-info" *ngIf="i.porcentaje">Porcentaje</span>
							<span class="badge bg-secondary" *ngIf="!i.porcentaje">Monto fijo</span>
						</td>
						<td class="text-end">{{ i.porcentaje ? (i.monto | number:'1.0-2') + '%' : (i.monto | number:'1.0-2') }}</td>
						<td>
							<span class="badge" [ngClass]="i.estado ? 'bg-success' : 'bg-danger'">{{ i.estado ? 'Activo' : 'Inactivo' }}</span>
						</td>
						<td class="text-nowrap">
							<button class="btn btn-sm btn-outline-primary me-1" title="Editar" (click)="openEditDef(i)">
								<i class="fas fa-edit"></i>
							</button>
							<button class="btn btn-sm btn-outline-secondary" title="Cambiar estado" (click)="toggleDef(i)">
								<i class="fas" [ngClass]="i.estado ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
							</button>
							<button class="btn btn-sm btn-outline-danger ms-1" title="Eliminar" (click)="confirmDeleteDef(i)">
								<i class="fas fa-trash"></i>
							</button>
						</td>
					</tr>
					<tr *ngIf="defPage.length === 0">
						<td colspan="6" class="text-center py-4">
							<div *ngIf="defLoading">Cargando definiciones...</div>
							<div *ngIf="!defLoading">No se encontraron definiciones de descuentos</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="d-flex justify-content-center align-items-center gap-2" *ngIf="defFiltered.length > 0">
			<button class="btn btn-light" [disabled]="defCurrentPage===1" (click)="goToPageDef(defCurrentPage-1)"><i class="fas fa-chevron-left"></i></button>
			<span class="text-muted">Página {{defCurrentPage}} de {{defTotalPages}}</span>
			<button class="btn btn-light" [disabled]="defCurrentPage===defTotalPages" (click)="goToPageDef(defCurrentPage+1)"><i class="fas fa-chevron-right"></i></button>
		</div>
	</div>

	<!-- Tabla: Definición de Becas -->
	<div [hidden]="activeTab!=='becas'">
		<div class="table-responsive">
			<table class="table align-middle">
				<thead class="table-light">
					<tr>
						<th>Nro</th>
						<th>Nombre</th>
						<th>Tipo</th>
						<th class="text-end">Valor</th>
						<th>Estado</th>
						<th class="text-nowrap">Acciones</th>
					</tr>
				</thead>
				<tbody>
					<tr *ngFor="let i of becaPage">
						<td>{{ i.cod_beca }}</td>
						<td>
							<div class="fw-semibold">{{ i.nombre_beca }}</div>
							<div class="text-muted small" *ngIf="i.descripcion">{{ i.descripcion }}</div>
						</td>
						<td>
							<span class="badge bg-info" *ngIf="i.porcentaje">Porcentaje</span>
							<span class="badge bg-secondary" *ngIf="!i.porcentaje">Monto fijo</span>
						</td>
						<td class="text-end">{{ i.porcentaje ? (i.monto | number:'1.0-2') + '%' : (i.monto | number:'1.0-2') }}</td>
						<td>
							<span class="badge" [ngClass]="i.estado ? 'bg-success' : 'bg-danger'">{{ i.estado ? 'Activo' : 'Inactivo' }}</span>
						</td>
						<td class="text-nowrap">
							<button class="btn btn-sm btn-outline-primary me-1" title="Editar" (click)="openEditBeca(i)">
								<i class="fas fa-edit"></i>
							</button>
							<button class="btn btn-sm btn-outline-secondary" title="Cambiar estado" (click)="toggleBeca(i)">
								<i class="fas" [ngClass]="i.estado ? 'fa-toggle-on' : 'fa-toggle-off'"></i>
							</button>
							<button class="btn btn-sm btn-outline-danger ms-1" title="Eliminar" (click)="confirmDeleteBeca(i)">
								<i class="fas fa-trash"></i>
							</button>
						</td>
					</tr>
					<tr *ngIf="becaPage.length === 0">
						<td colspan="6" class="text-center py-4">
							<div *ngIf="becaLoading">Cargando definiciones...</div>
							<div *ngIf="!becaLoading">No se encontraron definiciones de becas</div>
						</td>
					</tr>
				</tbody>
			</table>
		</div>
		<div class="d-flex justify-content-center align-items-center gap-2" *ngIf="becaFiltered.length > 0">
			<button class="btn btn-light" [disabled]="becaCurrentPage===1" (click)="goToPageBeca(becaCurrentPage-1)"><i class="fas fa-chevron-left"></i></button>
			<span class="text-muted">Página {{becaCurrentPage}} de {{becaTotalPages}}</span>
			<button class="btn btn-light" [disabled]="becaCurrentPage===becaTotalPages" (click)="goToPageBeca(becaCurrentPage+1)"><i class="fas fa-chevron-right"></i></button>
		</div>
	</div>

	<!-- Modal Creación/Edición Definición de Descuento -->
	<div class="modal" *ngIf="showDefModal">
		<div class="modal-content modal-lg">
			<div class="modal-header">
				<h2 class="modal-title">{{ defEditing ? 'Editar Descuento' : 'Nuevo Descuento' }}</h2>
				<button class="modal-close" (click)="closeDefModal()">×</button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-group">
						<label>Nombre</label>
						<input class="form-control" type="text" [(ngModel)]="defForm.nombre_descuento" name="defNombre" />
					</div>
					<div class="form-group">
						<label>Descripción</label>
						<textarea class="form-control" rows="2" [(ngModel)]="defForm.descripcion" name="defDesc"></textarea>
					</div>
					<div class="form-group">
						<label>Monto</label>
						<input class="form-control" type="number" step="0.01" [(ngModel)]="defForm.monto" name="defMonto" />
					</div>
					<div class="form-group">
						<label>Tipo</label>
						<select class="form-select" [(ngModel)]="defForm.porcentaje" name="defTipo">
							<option [ngValue]="true">Porcentaje (%)</option>
							<option [ngValue]="false">Monto fijo</option>
						</select>
					</div>
					<div class="form-group checkbox-group">
						<label>Activo</label>
						<input type="checkbox" [(ngModel)]="defForm.estado" name="defEstado" />
					</div>
				</div>
				<div class="server-error" *ngIf="defError">{{ defError }}</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" (click)="closeDefModal()" [disabled]="defSaving">Cancelar</button>
				<button class="btn btn-primary" (click)="saveDef()" [disabled]="defSaving">{{ defSaving ? 'Guardando...' : 'Guardar' }}</button>
			</div>
		</div>
	</div>

	<!-- Modal Confirmación Eliminar Definición de Descuento -->
	<div class="modal" *ngIf="showDefDeleteModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title">Confirmar Eliminación</h2>
				<button class="modal-close" (click)="cancelDeleteDef()">×</button>
			</div>
			<div class="modal-body">
				<p>¿Seguro que desea eliminar "{{ defToDelete?.nombre_descuento }}"?</p>
				<p class="modal-warning">Esta acción no se puede deshacer.</p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" (click)="cancelDeleteDef()" [disabled]="defDeleting">Cancelar</button>
				<button class="btn btn-danger" (click)="deleteDef()" [disabled]="defDeleting">{{ defDeleting ? 'Eliminando...' : 'Eliminar' }}</button>
			</div>
		</div>
	</div>

	<!-- Modal Creación/Edición Definición de Beca -->
	<div class="modal" *ngIf="showBecaModal">
		<div class="modal-content modal-lg">
			<div class="modal-header">
				<h2 class="modal-title">{{ becaEditing ? 'Editar Beca' : 'Nueva Beca' }}</h2>
				<button class="modal-close" (click)="closeBecaModal()">×</button>
			</div>
			<div class="modal-body">
				<div class="form-grid">
					<div class="form-group">
						<label>Nombre</label>
						<input class="form-control" type="text" [(ngModel)]="becaForm.nombre_beca" name="becaNombre" />
					</div>
					<div class="form-group">
						<label>Descripción</label>
						<textarea class="form-control" rows="2" [(ngModel)]="becaForm.descripcion" name="becaDesc"></textarea>
					</div>
					<div class="form-group">
						<label>Monto</label>
						<input class="form-control" type="number" step="0.01" [(ngModel)]="becaForm.monto" name="becaMonto" />
					</div>
					<div class="form-group">
						<label>Tipo</label>
						<select class="form-select" [(ngModel)]="becaForm.porcentaje" name="becaTipo">
							<option [ngValue]="true">Porcentaje (%)</option>
							<option [ngValue]="false">Monto fijo</option>
						</select>
					</div>
					<div class="form-group checkbox-group">
						<label>Activo</label>
						<input type="checkbox" [(ngModel)]="becaForm.estado" name="becaEstado" />
					</div>
				</div>
				<div class="server-error" *ngIf="becaError">{{ becaError }}</div>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" (click)="closeBecaModal()" [disabled]="becaSaving">Cancelar</button>
				<button class="btn btn-primary" (click)="saveBeca()" [disabled]="becaSaving">{{ becaSaving ? 'Guardando...' : 'Guardar' }}</button>
			</div>
		</div>
	</div>

	<!-- Modal Confirmación Eliminar Beca -->
	<div class="modal" *ngIf="showBecaDeleteModal">
		<div class="modal-content">
			<div class="modal-header">
				<h2 class="modal-title">Confirmar Eliminación</h2>
				<button class="modal-close" (click)="cancelDeleteBeca()">×</button>
			</div>
			<div class="modal-body">
				<p>¿Seguro que desea eliminar "{{ becaToDelete?.nombre_beca }}"?</p>
				<p class="modal-warning">Esta acción no se puede deshacer.</p>
			</div>
			<div class="modal-footer">
				<button class="btn btn-secondary" (click)="cancelDeleteBeca()" [disabled]="becaDeleting">Cancelar</button>
				<button class="btn btn-danger" (click)="deleteBeca()" [disabled]="becaDeleting">{{ becaDeleting ? 'Eliminando...' : 'Eliminar' }}</button>
			</div>
		</div>
	</div>

</div>
