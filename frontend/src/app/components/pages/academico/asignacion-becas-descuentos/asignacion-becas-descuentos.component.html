<div class="container-fluid py-3">
	<h4 class="mb-3">Asignación de Becas / Descuentos</h4>

	<!-- Búsqueda por Código CETA -->
	<div class="card mb-3">
		<div class="card-body">
			<form [formGroup]="searchForm" (ngSubmit)="buscarPorCodCeta()">
				<div class="row g-3 align-items-end">
					<div class="col-sm-4">
						<label class="form-label">Código CETA</label>
						<div class="input-group">
							<input type="text" class="form-control" formControlName="cod_ceta" />
							<button type="submit" class="btn btn-primary"><i class="fas fa-search me-1"></i>Buscar</button>
						</div>
					</div>
					<div class="col-sm-4">
						<label class="form-label">Apellido paterno</label>
						<input type="text" class="form-control" [value]="student.ap_paterno" disabled />
					</div>
					<div class="col-sm-4">
						<label class="form-label">Apellido materno</label>
						<input type="text" class="form-control" [value]="student.ap_materno" disabled />
					</div>
					<div class="col-sm-4">
						<label class="form-label">Nombres</label>
						<input type="text" class="form-control" [value]="student.nombres" disabled />
					</div>
					<div class="col-sm-4">
						<label class="form-label">Pensum</label>
						<input type="text" class="form-control" [value]="student.pensum" disabled />
					</div>
					<div class="col-sm-4">
						<label class="form-label">Gestión</label>
						<select class="form-select" formControlName="gestion" (change)="onGestionChange()">
							<option value="">Seleccione...</option>
							<option *ngFor="let g of gestionesCatalogo" [value]="g">{{ g }}</option>
						</select>
					</div>
					<div class="col-12">
						<label class="form-label">Grupo</label>
						<div class="d-flex flex-wrap gap-2">
							<ng-container *ngFor="let gd of gruposDetalle">
								<span class="badge bg-primary">{{ gd.curso }}</span>
								<span class="badge" [ngClass]="{ 'bg-warning text-dark': gd.tipo==='NORMAL', 'bg-info': gd.tipo==='ARRASTRE' }">{{ gd.tipo }}</span>
							</ng-container>
							<span *ngIf="!gruposDetalle.length" class="text-muted">Sin grupos</span>
						</div>
					</div>
					<div class="col-12" *ngIf="noInscrito">
						<div class="alert alert-warning py-2 mb-0">El estudiante no está inscrito en ninguna gestión.</div>
					</div>
				</div>
			</form>
				<div class="d-flex justify-content-end mt-2">
					<button type="button" class="btn btn-outline-danger" (click)="limpiarFormulario()"><i class="fas fa-eraser me-1"></i>Limpiar</button>
				</div>
		</div>
	</div>

	<div class="row">
		<!-- Tabla de asignaciones (preview) -->
		<div class="col-lg-6 mb-3">
			<div class="card h-100">
				<div class="card-header d-flex align-items-center justify-content-between">
					<span>Asignaciones del Estudiante</span>
				</div>
				<div class="card-body">
					<div class="table-responsive table-scroll-5">
						<table class="table table-sm table-striped align-middle">
							<thead>
								<tr>
									<th style="width:60px">Nro</th>
									<th>Tipo</th>
									<th>Nombre</th>
									<th>Valor</th>
									<th>Inscripción</th>
									<th>Estado</th>
									<th style="width:60px"></th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let a of asignaciones">
									<td>{{ a.nro }}</td>
									<td><span class="badge" [ngClass]="{ 'bg-success': a.tipo==='BECA', 'bg-info': a.tipo==='DESCUENTO' }">{{ a.tipo }}</span></td>
									<td>{{ a.nombre }}</td>
									<td>{{ a.valor }}</td>
									<td>
										<span class="badge" [ngClass]="{ 'bg-warning text-dark': a.inscripcion==='NORMAL', 'bg-info': a.inscripcion==='ARRASTRE' }">{{ a.inscripcion }}</span>
									</td>
									<td>{{ a.estado }}</td>
									<td class="text-end">
										<button class="btn btn-sm btn-outline-danger" title="Eliminar" (click)="eliminarAsignacion(a)">
											<i class="fas fa-trash"></i>
										</button>
									</td>
								</tr>
								<tr *ngIf="!asignaciones.length">
									<td colspan="7" class="text-center text-muted py-3">Sin asignaciones</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

		<!-- Catálogo de becas/descuentos -->
		<div class="col-lg-6 mb-3">
			<div class="card h-100" [ngClass]="{ 'border border-danger': !!defSelectError }">
				<div class="card-header">
					<div class="d-flex align-items-center gap-2">
						<select class="form-select" style="max-width: 220px" [(ngModel)]="selectedTipo">
							<option value="beca">Becas</option>
							<option value="descuento">Descuentos</option>
						</select>
						<input class="form-control" placeholder="Buscar..." [(ngModel)]="defSearch" />
					</div>
				</div>
				<div class="card-body">
					<div *ngIf="defSelectError" class="mb-2"><small class="text-danger">{{ defSelectError }}</small></div>
					<div class="table-responsive table-scroll-5">
						<table class="table table-sm table-hover align-middle">
							<thead>
								<tr>
									<th>Nombre</th>
									<th style="width:120px">Tipo</th>
									<th style="width:120px">Valor</th>
									<th style="width:40px"></th>
								</tr>
							</thead>
							<tbody>
								<tr *ngFor="let d of definicionesFiltradas" [class.table-active]="keyOf(d)===selectedRowKey" (click)="selectDef(d)">
									<td>{{ $any(d).nombre_beca || $any(d).nombre_descuento }}</td>
									<td>
										<span class="badge bg-primary" *ngIf="$any(d).porcentaje">Porcentaje</span>
										<span class="badge bg-secondary" *ngIf="!$any(d).porcentaje">Monto</span>
									</td>
									<td>
										<span *ngIf="$any(d).porcentaje">{{ $any(d).monto || 0 }}%</span>
										<span *ngIf="!$any(d).porcentaje">{{ $any(d).monto || 0 }} Bs</span>
									</td>
									<td>
										<button class="btn btn-sm" [ngClass]="(keyOf(d)===selectedRowKey) ? 'btn-success' : 'btn-outline-primary'" (click)="toggleSelect(d); $event.stopPropagation();">
											<i class="fas" [ngClass]="(keyOf(d)===selectedRowKey) ? 'fa-check' : 'fa-plus'"></i>
										</button>
									</td>
								</tr>
								<tr *ngIf="!definicionesFiltradas.length">
									<td colspan="4" class="text-center text-muted py-3">Sin resultados</td>
								</tr>
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Totales y observaciones -->
	<div class="card">
		<div class="card-body">
			<div class="row g-2 align-items-end mb-2" *ngIf="cuotas.length">
				<div class="col-sm-4 col-md-3">
					<label class="form-label">Tipo Inscripción</label>
					<select class="form-select" [ngModel]="contextForm.value?.tipoInscripcion" (ngModelChange)="contextForm.patchValue({ tipoInscripcion: $event }); updateDescuentoTotal(getSelectedDef());">
						<option value="">Seleccione...</option>
						<option *ngFor="let t of tipoInscripcionOptions" [value]="t">{{ t }}</option>
					</select>
				</div>
			</div>
			<div class="table-responsive mb-3">
				<table class="table table-sm align-middle">
					<thead>
						<tr>
							<th style="width:40px">
								<input type="checkbox" class="form-check-input" [checked]="allSelected" (change)="toggleAll($event.target.checked)" />
							</th>
							<th>Cuota</th>
							<th>Estado</th>
							<th>Monto referencial</th>
							<th>Descuento</th>
							<th>Total a pagar</th>
						</tr>
					</thead>
					<tbody>
						<tr *ngFor="let c of cuotas; index as i">
							<td>
								<input type="checkbox" class="form-check-input" [disabled]="!isSelectable(c)" [(ngModel)]="c.selected" (ngModelChange)="toggleCuota(i, $event)" />
							</td>
							<td>{{ c.numero_cuota }}</td>
							<td>{{ c.estado_pago }}</td>
							<td>{{ c.monto | number:'1.2-2' }}</td>
							<td>{{ descuentoPorCuota(c) | number:'1.2-2' }}</td>
							<td>{{ totalPorCuota(c) | number:'1.2-2' }}</td>
						</tr>
						<tr *ngIf="!cuotas.length">
							<td colspan="6" class="text-center text-muted py-2">Sin cuotas</td>
						</tr>
					</tbody>
				</table>
			</div>
			<form [formGroup]="contextForm">
				<div class="row g-3">
					<div class="col-sm-4 col-md-3">
						<label class="form-label">Monto de Referencia</label>
						<input type="text" class="form-control" formControlName="montoReferencia" />
					</div>
					<div class="col-sm-4 col-md-3">
						<label class="form-label">Descuento</label>
						<input type="text" class="form-control" formControlName="descuento" />
					</div>
					<div class="col-sm-4 col-md-3">
						<label class="form-label">Total a Pagar</label>
						<input type="text" class="form-control" formControlName="totalPagar" />
					</div>
					<div class="row g-3 mt-1">
						<div class="col-lg-6">
							<div class="row g-3">
								<div class="col-sm-6">
									<label class="form-label">Código Archivo</label>
									<input type="text" class="form-control" formControlName="codigoArchivo" />
								</div>
								<div class="col-sm-6">
									<label class="form-label">Fecha solicitud</label>
									<input type="date" class="form-control" formControlName="fechaSolicitud" [ngClass]="{ 'is-invalid': submitted && contextForm.get('fechaSolicitud')?.invalid }" />
									<div *ngIf="submitted && contextForm.get('fechaSolicitud')?.invalid" class="invalid-feedback d-block">
										Debe ingresar la fecha de solicitud.
									</div>
								</div>
								<div class="col-sm-6">
									<label class="form-label">Meses</label>
									<input type="text" class="form-control" formControlName="meses" />
								</div>
							</div>
						</div>
						<div class="col-lg-6">
							<label class="form-label">Observaciones</label>
							<textarea rows="3" class="form-control"
									formControlName="observaciones"
									[ngClass]="{ 'is-invalid': submitted && contextForm.get('observaciones')?.invalid }"></textarea>
							<div *ngIf="submitted && contextForm.get('observaciones')?.invalid" class="invalid-feedback d-block">
								Debe ingresar una observación.
							</div>
						</div>
					</div>
				</div>
			</form>
			<div class="d-flex gap-2 mt-3">
				<button class="btn btn-success" (click)="asignarSeleccion()"><i class="fas fa-check me-1"></i>Asignar</button>
				<button class="btn btn-outline-secondary" (click)="cancelarSeleccion()"><i class="fas fa-times me-1"></i>Cancelar</button>
			</div>
		</div>
	</div>
</div>
