<div class="usuario-form-container">
  <div class="form-header" *ngIf="!modalMode">
    <h1 class="form-title">{{ isEditMode ? 'Editar Usuario' : 'Nuevo Usuario' }}</h1>
    <button class="btn-secondary" (click)="onCancel()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
  </div>

  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
  </div>

  <form [formGroup]="usuarioForm" (ngSubmit)="onSubmit()" class="usuario-form">
    <div class="form-row">
      <div class="form-group">
        <label for="nickname">Usuario</label>
        <input
          type="text"
          id="nickname"
          formControlName="nickname"
          class="form-control"
          [class.is-invalid]="(submitted || f['nickname'].touched) && f['nickname'].errors"
        >
        <div class="invalid-feedback" *ngIf="(submitted || f['nickname'].touched) && f['nickname'].errors">
          <span *ngIf="f['nickname'].errors['required']">Usuario es requerido</span>
          <span *ngIf="f['nickname'].errors['server']">{{ f['nickname'].errors['server'] }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="ci">CI *</label>
        <input
          type="text"
          id="ci"
          formControlName="ci"
          class="form-control"
          [class.is-invalid]="(submitted || f['ci'].touched) && f['ci'].errors"
        >
        <div class="invalid-feedback" *ngIf="(submitted || f['ci'].touched) && f['ci'].errors">
          <span *ngIf="f['ci'].errors['required']">CI es requerido</span>
          <span *ngIf="f['ci'].errors['server']">{{ f['ci'].errors['server'] }}</span>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="nombre">Nombre *</label>
        <input
          type="text"
          id="nombre"
          formControlName="nombre"
          class="form-control"
          [class.is-invalid]="(submitted || f['nombre'].touched) && f['nombre'].errors"
        >
        <div class="invalid-feedback" *ngIf="(submitted || f['nombre'].touched) && f['nombre'].errors">
          <span *ngIf="f['nombre'].errors['required']">Nombre es requerido</span>
          <span *ngIf="f['nombre'].errors['server']">{{ f['nombre'].errors['server'] }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="ap_paterno">Apellido Paterno *</label>
        <input
          type="text"
          id="ap_paterno"
          formControlName="ap_paterno"
          class="form-control"
          [class.is-invalid]="(submitted || f['ap_paterno'].touched) && f['ap_paterno'].errors"
        >
        <div class="invalid-feedback" *ngIf="(submitted || f['ap_paterno'].touched) && f['ap_paterno'].errors">
          <span *ngIf="f['ap_paterno'].errors['required']">Apellido Paterno es requerido</span>
          <span *ngIf="f['ap_paterno'].errors['server']">{{ f['ap_paterno'].errors['server'] }}</span>
        </div>
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label for="ap_materno">Apellido Materno</label>
        <input
          type="text"
          id="ap_materno"
          formControlName="ap_materno"
          class="form-control"
        >
      </div>

      <div class="form-group">
        <label>Funciones del Usuario</label>
        <button
          type="button"
          class="btn-funciones"
          (click)="openFuncionesModal()"
        >
          <i class="fas fa-tasks"></i>
          Asignar Funciones
          <span class="badge-count" *ngIf="funcionesCount > 0">{{ funcionesCount }}</span>
        </button>
        <small class="form-text text-muted">
          Funciones seleccionadas: {{ funcionesCount }}
        </small>
      </div>
    </div>

    <!-- Contraseñas en creación -->
    <div class="form-row" *ngIf="!isEditMode">
      <div class="form-group">
        <label for="contrasenia">Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showPassword ? 'text' : 'password'"
            id="contrasenia"
            formControlName="contrasenia"
            class="form-control"
            [class.is-invalid]="(submitted || f['contrasenia'].touched) && f['contrasenia'].errors"
          >
          <button
            type="button"
            class="password-toggle-btn"
            (click)="togglePasswordVisibility()"
          >
            <i class="fas" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="invalid-feedback" *ngIf="(submitted || f['contrasenia'].touched) && f['contrasenia'].errors">
          <span *ngIf="f['contrasenia'].errors['required']">Contraseña es requerida</span>
          <span *ngIf="f['contrasenia'].errors['minlength']">Contraseña debe tener al menos 6 caracteres</span>
          <span *ngIf="f['contrasenia'].errors['server']">{{ f['contrasenia'].errors['server'] }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="contraseniaConfirm">Confirmar Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showConfirmPassword ? 'text' : 'password'"
            id="contraseniaConfirm"
            formControlName="contraseniaConfirm"
            class="form-control"
            [class.is-invalid]="(submitted || f['contraseniaConfirm'].touched) && (f['contraseniaConfirm'].errors || usuarioForm.errors?.['matching'])"
          >
          <button
            type="button"
            class="password-toggle-btn"
            (click)="toggleConfirmPasswordVisibility()"
          >
            <i class="fas" [ngClass]="showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="invalid-feedback" *ngIf="(submitted || f['contraseniaConfirm'].touched) && (f['contraseniaConfirm'].errors || usuarioForm.errors?.['matching'])">
          <span *ngIf="f['contraseniaConfirm'].errors?.['required']">Confirmar contraseña es requerido</span>
          <span *ngIf="usuarioForm.errors?.['matching']">Las contraseñas no coinciden</span>
          <span *ngIf="f['contraseniaConfirm'].errors && f['contraseniaConfirm'].errors['server']">{{ f['contraseniaConfirm'].errors['server'] }}</span>
        </div>
      </div>
    </div>

    <!-- Opción de restablecer contraseña en edición -->
    <div class="form-row" *ngIf="isEditMode">
      <div class="form-group">
        <div class="form-check">
          <input type="checkbox" id="resetPassword" formControlName="resetPassword" class="form-check-input">
          <label for="resetPassword" class="form-check-label">Restablecer contraseña</label>
        </div>
      </div>
    </div>

    <!-- Contraseñas visibles cuando se restablece en edición -->
    <div class="form-row" *ngIf="isEditMode && usuarioForm.get('resetPassword')?.value">
      <div class="form-group">
        <label for="contrasenia">Nueva Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showPassword ? 'text' : 'password'"
            id="contrasenia"
            formControlName="contrasenia"
            class="form-control"
            [class.is-invalid]="(submitted || f['contrasenia'].touched) && f['contrasenia'].errors"
          >
          <button
            type="button"
            class="password-toggle-btn"
            (click)="togglePasswordVisibility()"
          >
            <i class="fas" [ngClass]="showPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="invalid-feedback" *ngIf="(submitted || f['contrasenia'].touched) && f['contrasenia'].errors">
          <span *ngIf="f['contrasenia'].errors['required']">Contraseña es requerida</span>
          <span *ngIf="f['contrasenia'].errors['minlength']">Contraseña debe tener al menos 6 caracteres</span>
          <span *ngIf="f['contrasenia'].errors && f['contrasenia'].errors['server']">{{ f['contrasenia'].errors['server'] }}</span>
        </div>
      </div>

      <div class="form-group">
        <label for="contraseniaConfirm">Confirmar Nueva Contraseña *</label>
        <div class="password-input-wrapper">
          <input
            [type]="showConfirmPassword ? 'text' : 'password'"
            id="contraseniaConfirm"
            formControlName="contraseniaConfirm"
            class="form-control"
            [class.is-invalid]="(submitted || f['contraseniaConfirm'].touched) && (f['contraseniaConfirm'].errors || usuarioForm.errors?.['matching'])"
          >
          <button
            type="button"
            class="password-toggle-btn"
            (click)="toggleConfirmPasswordVisibility()"
          >
            <i class="fas" [ngClass]="showConfirmPassword ? 'fa-eye-slash' : 'fa-eye'"></i>
          </button>
        </div>
        <div class="invalid-feedback" *ngIf="(submitted || f['contraseniaConfirm'].touched) && (f['contraseniaConfirm'].errors || usuarioForm.errors?.['matching'])">
          <span *ngIf="f['contraseniaConfirm'].errors?.['required']">Confirmar contraseña es requerido</span>
          <span *ngIf="usuarioForm.errors?.['matching']">Las contraseñas no coinciden</span>
          <span *ngIf="f['contraseniaConfirm'].errors && f['contraseniaConfirm'].errors['server']">{{ f['contraseniaConfirm'].errors['server'] }}</span>
        </div>
      </div>
    </div>

    <div class="form-row" *ngIf="isEditMode">
      <div class="form-group">
        <label for="estado">Estado</label>
        <div class="toggle-switch">
          <input
            type="checkbox"
            id="estado"
            formControlName="estado"
            class="toggle-input"
          >
          <label for="estado" class="toggle-label">
            <span class="toggle-inner"></span>
            <span class="toggle-switch-indicator"></span>
          </label>
          <span class="toggle-status">
            {{ usuarioForm.get('estado')?.value ? 'Activo' : 'Inactivo' }}
          </span>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn-secondary" (click)="onCancel()">Cancelar</button>
      <button type="submit" class="btn-primary" [disabled]="isSubmitting">
        <span *ngIf="isSubmitting">
          <i class="fas fa-spinner fa-spin"></i> Guardando...
        </span>
        <span *ngIf="!isSubmitting">
          <i class="fas fa-save"></i> {{ isEditMode ? 'Actualizar' : 'Guardar' }}
        </span>
      </button>
    </div>
  </form>
</div>

<!-- Modal de Asignación de Funciones -->
<div class="modal-overlay" *ngIf="showFuncionesModal" (click)="closeFuncionesModal()">
  <div class="modal-content funciones-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Asignar Funciones al Usuario</h3>
      <button type="button" class="btn-close" (click)="closeFuncionesModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="modal-body">
      <!-- Selector de Rol -->
      <div class="rol-selector-container">
        <label for="rolSelector" class="rol-selector-label">
          <i class="fas fa-user-tag"></i>
          Copiar funciones desde un rol:
        </label>
        <div class="rol-selector-wrapper">
          <select
            id="rolSelector"
            [(ngModel)]="selectedRolId"
            [ngModelOptions]="{standalone: true}"
            (change)="onRolChange()"
            class="rol-select"
            [disabled]="loadingRolFunciones"
          >
            <option [ngValue]="null">Seleccione un rol...</option>
            <option *ngFor="let rol of roles" [ngValue]="rol.id_rol">
              {{ rol.nombre }}
            </option>
          </select>
          <span *ngIf="loadingRolFunciones" class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
          </span>
        </div>
        <small class="rol-help-text">
          Las funciones del rol seleccionado se agregarán a las funciones actuales
        </small>
      </div>

      <!-- Búsqueda -->
      <div class="search-box">
        <input
          type="text"
          [(ngModel)]="funcionesSearchTerm"
          [ngModelOptions]="{standalone: true}"
          (input)="filterFunciones()"
          placeholder="Buscar funciones..."
          class="search-input"
        >
      </div>

      <!-- Contador de funciones seleccionadas -->
      <div class="selected-count">
        <strong>Funciones seleccionadas:</strong> {{ selectedFunciones.length }}
      </div>

      <!-- Tabs por módulo -->
      <div class="tabs-container">
        <button
          type="button"
          *ngFor="let modulo of modulos"
          class="tab-button"
          [class.active]="selectedModulo === modulo"
          [class.has-selected]="moduloHasFuncionesSeleccionadas(modulo)"
          (click)="selectedModulo = modulo; filterFunciones()">
          {{ modulo }}
        </button>
      </div>

      <!-- Loading -->
      <div *ngIf="loadingFunciones" class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
      </div>

      <!-- Lista de funciones -->
      <div *ngIf="!loadingFunciones" class="funciones-list">
        <!-- Checkbox seleccionar todas -->
        <div class="select-all-container">
          <label class="checkbox-container">
            <input
              type="checkbox"
              [checked]="allFuncionesSelected()"
              (change)="toggleAllFunciones($event)"
            >
            <span class="checkmark"></span>
            <span class="label-text">Seleccionar todas</span>
          </label>
        </div>

        <!-- Items de funciones -->
        <div class="funciones-items">
          <div *ngFor="let funcion of filteredFuncionesDisponibles" class="funcion-item">
            <label class="checkbox-container">
              <input
                type="checkbox"
                [checked]="isFuncionSelected(funcion.id_funcion)"
                (change)="toggleFuncion(funcion.id_funcion)"
              >
              <span class="checkmark"></span>
              <div class="funcion-details">
                <div class="funcion-header">
                  <span class="funcion-codigo">{{ funcion.codigo }}</span>
                </div>
                <div class="funcion-nombre">{{ funcion.nombre }}</div>
                <div class="funcion-descripcion" *ngIf="funcion.descripcion">{{ funcion.descripcion }}</div>
              </div>
            </label>
          </div>
          <div *ngIf="filteredFuncionesDisponibles.length === 0" class="no-funciones">
            No se encontraron funciones
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn-secondary" (click)="closeFuncionesModal()">
        Cerrar
      </button>
    </div>
  </div>
</div>
